---
title: 使用儲存體遷移服務遷移檔案伺服器
description: 搜尋引擎結果主題的簡短描述
author: jasongerend
ms.author: jgerend
manager: elizapo
ms.date: 01/29/2021
ms.topic: article
ms.openlocfilehash: d38a6c058d6629f0b73e613e417dea76a22bc71b
ms.sourcegitcommit: f89c1bc137ff92eeca2499131854287f28851f63
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/30/2021
ms.locfileid: "99084946"
---
# <a name="use-storage-migration-service-to-migrate-a-server"></a>使用儲存體遷移服務遷移伺服器

本主題討論如何使用 [儲存體遷移服務](overview.md) 和 Windows Admin Center，將伺服器（包括其檔案和設定）遷移至另一部伺服器。 當您安裝服務並開啟任何必要的防火牆埠之後，遷移會執行三個步驟：清查您的伺服器、傳輸資料，然後切換到新的伺服器。

## <a name="step-0-install-storage-migration-service-and-check-firewall-ports"></a>步驟0：安裝儲存體遷移服務並檢查防火牆埠

開始之前，請先安裝儲存體遷移服務，並確定所需的防火牆埠已開啟。

1. 檢查 [儲存體遷移服務需求](overview.md#requirements) ，並在您的電腦或管理伺服器上安裝 [Windows Admin Center](../../manage/windows-admin-center/overview.md) （如果尚未安裝）。 如果遷移已加入網域的來源電腦，您必須在與來源電腦聯結的相同網域或樹系的伺服器上安裝和執行儲存體遷移服務。
2. 在 Windows Admin Center 中，連接到執行 Windows Server 2019 的 orchestrator 伺服器。 <br>這是您將安裝「儲存體遷移服務」的伺服器，並使用此伺服器來管理遷移。 如果您只是要遷移一部伺服器，您可以使用目的地伺服器，只要該伺服器執行的是 Windows Server 2019。 建議您針對任何多伺服器遷移使用個別的協調流程伺服器。
3. 移至 Windows Admin Center) 的 **伺服器管理員** (> **儲存體遷移服務** ，然後選取 [ **安裝** ] 以安裝儲存體遷移服務及其必要元件 (如 [圖 1] 所示) 所示。
    ![儲存體遷移服務頁面的螢幕擷取畫面，其中顯示 [安裝] 按鈕 ](media/migrate/install.png) **圖1：安裝儲存體遷移服務**
4. 在執行 Windows Server 2019 的所有目的地伺服器上安裝存放裝置遷移服務 proxy。 如此一來，在目的地伺服器上安裝時，傳送速率會加倍。 <br>若要這樣做，請在 Windows Admin Center 中連線到目的地伺服器，然後移至 Windows Admin Center 中的 **伺服器管理員** () [ **角色和功能**] > [ **功能**]，選取 [ **儲存體遷移服務 Proxy**]，然後選取 [ **安裝**]。
5. 如果您想要在 Windows 容錯移轉叢集之間進行遷移，請在 orchestrator 伺服器上安裝容錯移轉叢集工具。 <br>若要這樣做，請在 Windows Admin Center 中連線到 orchestrator 伺服器，然後移至 Windows Admin Center 中的 **伺服器管理員** () [ **角色和功能**]、[> **功能**]、[> **>**]、遠端伺服器管理工具 [ **功能管理工具**]，然後選取 [ **容錯移轉叢集工具**]，再選取 [ **安裝**]。
6. 在所有來源伺服器上，以及執行 Windows server 2012 R2 或 windows server 2016 的任何目的地伺服器上，在 Windows Admin Center 中連線到每部伺服器，移至 Windows Admin Center) >**防火牆** 內送規則中的 **伺服器管理員** (，然後  >  檢查是否已啟用下列規則：
    - 檔案及印表機共用 (SMB-In)
    - Netlogon 服務 (NP) 
    - Windows Management Instrumentation (DCOM-In)
    - Windows Management Instrumentation (WMI-In)

   如果您使用協力廠商防火牆，要開啟的輸入埠範圍為 TCP/445 (SMB) 、TCP/135 (RPC/DCOM 端點對應程式) ，以及 TCP 1025-65535 (RPC/DCOM 暫時埠) 。 儲存體遷移服務埠為 TCP/28940 (Orchestrator) 和 TCP/28941 (Proxy) 。

7. 如果您使用協調器伺服器來管理遷移，而您想要下載事件或您所傳送之資料的記錄，請檢查該伺服器上是否已啟用 (SMB 的檔案和印表機共用) 防火牆規則。

## <a name="step-1-create-a-job-and-inventory-your-servers-to-figure-out-what-to-migrate"></a>步驟1：建立作業和清查您的伺服器，以找出要遷移的內容

在此步驟中，您會指定要遷移的伺服器，然後進行掃描以收集其檔案和設定的相關資訊。

1. 選取 [ **新增作業**]、為工作命名，然後選取要遷移使用 Samba 的 Windows 伺服器和叢集或 Linux 伺服器。 然後選取 [確定]  。
2. 在 [ **輸入認證** ] 頁面上，輸入可在您要遷移的伺服器上運作的管理員認證，然後選取 **[下一步]**。 <br>如果您要從 Linux 伺服器進行遷移，請改為在 **Samba 認證** 和 **Linux 認證** 頁面上輸入認證，包括 SSH 密碼或私密金鑰。

3. 選取 [ **新增裝置**]，輸入來源伺服器名稱或叢集檔案伺服器的名稱，然後選取 **[確定]**。 <br>針對您想要清查的任何其他伺服器重複此步驟。

4. 選取 [ **開始掃描**]。<br>當掃描完成時，頁面會更新以顯示。
    ![螢幕擷取畫面：顯示已準備好掃描的伺服器 ](media/migrate/inventory.png) **圖2：清查伺服器**
5. 選取每部伺服器以檢查已清查的共用、設定、網路介面卡和磁片區。 <br><br>儲存體遷移服務不會傳送我們知道可能會干擾 Windows 作業的檔案或資料夾，因此在此版本中，您會看到位於 Windows 系統資料夾中的任何共用的警告。 您必須在傳輸階段略過這些共用。 如需詳細資訊，請參閱 [哪些檔案和資料夾已從傳輸中排除](faq.md#what-files-and-folders-are-excluded-from-transfers)。
6. 選取 **[下一步]** 以移至 [傳送資料]。

## <a name="step-2-transfer-data-from-your-old-servers-to-the-destination-servers"></a>步驟2：將資料從舊的伺服器傳送至目的地伺服器

在此步驟中，您會在指定要將資料放在目的地伺服器上的位置之後傳送資料。

1. 在 [**傳輸資料**  >  **輸入認證**] 頁面上，輸入可在您想要遷移目的地伺服器上運作的系統管理員認證，然後選取 **[下一步]**。
2. 在 [ **新增目的地裝置和** 對應] 頁面上，會列出第一個來源伺服器。 輸入您想要遷移的伺服器或叢集檔案伺服器的名稱，然後選取 [ **掃描裝置**]。 如果從已加入網域的來源電腦進行遷移，則目的地伺服器必須加入相同的網域。 您也可以按一下 [建立新的 Azure VM]，然後使用嚮導在 Azure 中部署新的目的地伺服器。 這會自動調整您的 VM 大小、布建儲存體、格式化磁片、加入網域，以及將儲存體遷移服務 proxy 新增至 Windows Server 2019 目的地。 您可以從 Windows Server 2019 選擇 (建議的) 、Windows Server 2016 和 Windows Server 2012 R2 Vm 的任何大小，並使用受控磁片。

    > [!NOTE]
    > 使用「建立新的 Azure VM」需要您具備：
    > - 有效的 Azure 訂用帳戶。
    > - 您有建立許可權的現有 Azure 計算資源群組。
    > - 現有的 Azure 虛擬網路和子網。
    > - 系結至虛擬網路和子網的 Azure Express Route 或 VPN 解決方案，可讓您從這個 Azure IaaS VM 連線至內部部署用戶端、網域控制站、存放裝置遷移服務協調器電腦、Windows Admin Center 電腦，以及要遷移的來源電腦。

    以下影片顯示如何使用儲存體遷移服務遷移至 Azure Vm。
    > [!VIDEO https://www.youtube-nocookie.com/embed/k8Z9LuVL0xQ]

3. 將來源磁片區對應至目的地磁片區，清除您不想要傳送之任何共用的 [ **包含** ] 核取方塊 (包括位於 [Windows 系統] 資料夾中的任何系統管理共用) ，然後選取 **[下一步]**。
   ![顯示來源伺服器及其磁片區和共用的螢幕擷取畫面，以及要將其傳輸到目的地 ](media/migrate/transfer.png) **圖3的位置：來源伺服器及其儲存體將傳輸到的位置**
4. 為其他來源伺服器新增目的地伺服器和對應，然後選取 **[下一步]**。
5. 在 [ **調整傳輸設定** ] 頁面上，指定是否要遷移來源伺服器上的本機使用者和群組，然後選取 **[下一步]**。 這可讓您在目的地伺服器上重新建立任何本機使用者和群組，以便將檔案或共用許可權設定為本機使用者和群組。 以下是遷移本機使用者和群組時的選項：

    - 預設會選取 **[使用相同名稱重新命名帳戶**]，並遷移來源伺服器上的所有本機使用者和群組。 如果在來源和目的地上找到具有相同名稱的本機使用者或群組，除非內建 (例如系統管理員使用者和系統管理員群組) ，否則會將它們重新命名為目的地。 如果來源或目的地伺服器是網域控制站，請勿使用此設定。
    - **重複使用具有相同名稱的帳戶** ，其名稱對應與來源和目的地上的使用者和群組同名。 如果來源或目的地伺服器是網域控制站，請勿使用此設定。
    - **請勿傳送使用者和群組** 略過遷移本機使用者和群組（當您的來源或目的地是網域控制站時，或植入 DFS 複寫的資料 (DFS 複寫不支援) 的本機群組和使用者時，這是必要的。

   > [!NOTE]
   > 已停用目的地上的已遷移使用者帳戶，並指派127字元密碼（複雜和隨機），因此您必須加以啟用，並在您完成繼續使用時指派新密碼。 這有助於確保任何舊的帳戶在來源上有遺忘和弱式密碼，不會繼續成為目的地的安全性問題。 您也可能想要查看 [區域系統管理員密碼解決方案 (LAPS) ](https://www.microsoft.com/download/details.aspx?id=46899) 以管理本機系統管理員密碼的方式。

6. 選取 [ **驗證** ]，然後選取 **[下一步]**。
7. 選取 [ **開始傳送** ] 以開始傳送資料。<br>第一次傳送時，我們會將目的地中的任何現有檔案移至備份檔案夾。 在後續的傳輸中，我們預設會重新整理目的地，而不會先進行備份。 <br>此外，儲存體遷移服務也足以處理重迭的共用，我們不會在相同的作業中複製相同的資料夾兩次。
8. 傳輸完成後，請查看目的地伺服器，以確定一切都已正確傳輸。 如果您想要下載任何未傳送檔案的記錄檔，請選取 [ **錯誤記錄** 檔]。

   > [!NOTE]
   > 如果您想要保留傳輸的審核記錄，或打算在作業中執行多個傳輸，請按一下 [ **傳送記錄** ] 或其他記錄檔儲存選項來儲存 CSV 複本。 每次後續的傳送都會覆寫先前執行的資料庫資訊。

至此，您有三個選項：

- **移至下一個步驟**，讓目的地伺服器採用來源伺服器的身分識別。
- **請考慮遷移完成，** 而不需接管來源伺服器的身分識別。
- **再次傳輸**，只複製上次傳送後已更新的檔案。

如果您的目標是要將檔案與 Azure 同步，您可以在傳輸檔案之後或移至目的地伺服器之後，使用 Azure 檔案同步設定目的地伺服器 (請參閱 [規劃 Azure 檔案同步部署](/azure/storage/files/storage-sync-files-planning)) 。

## <a name="step-3-cut-over-to-the-new-servers"></a>步驟3：切換至新的伺服器

在此步驟中，您會從來源伺服器移至目的地伺服器，並將 IP 位址和電腦名稱稱移至目的地伺服器。 完成此步驟之後，應用程式與使用者會透過您從中遷移之伺服器的名稱和位址來存取新的伺服器。

1. 如果您已經離開遷移作業，請在 Windows Admin Center 中，移至 **伺服器管理員**  >  **儲存體遷移服務**，然後選取要完成的作業。
2. 在 [**切換至新的伺服器**  >  **輸入認證**] 頁面上，選取 **[下一步]** 以使用您先前輸入的認證。

   如果您的目的地是叢集檔案伺服器，您可能需要提供具有許可權的認證，以從網域移除叢集，然後以新名稱重新新增。

3. 在 [ **設定** 切換] 頁面上，指定目的地上的哪一個網路介面卡應該接管來源上每個介面卡的設定。 這會在進行轉換時，將 IP 位址從來源移至目的地，讓來源伺服器成為新的 DHCP 或靜態 IP 位址。 您可以選擇略過所有網路遷移或特定介面。
4. 指定在轉換將位址移至目的地之後，要用於來源伺服器的 IP 位址。 您可以使用 DHCP 或靜態位址。 如果使用靜態位址，新的子網必須和舊的子網相同，否則轉換將會失敗。
    ![顯示來源伺服器及其 IP 位址和電腦名稱稱的螢幕擷取畫面，以及在轉換過的圖4之後將取代的電腦名稱稱 ](media/migrate/cutover.png) **：來源伺服器及其網路設定將如何移至目的地**
5. 指定在目的地伺服器接管其名稱之後，如何重新命名來源伺服器。 您可以使用隨機產生的名稱或輸入一個。 然後選取 [下一步]。
6. 在 [調整切換 **設定**] 頁面上選取 **[下一步]** 。
7. 選取 [**驗證來源和目的地裝置**] 頁面上的 [**驗證**]，然後選取 **[下一步]**。
8. 當您準備好執行轉換時，請選取 [ **開始** 轉換]。 <br>使用者和應用程式可能會在位址和名稱移動時遇到中斷，且伺服器會重新開機數次，但不會受到遷移的影響。 切換所花的時間長短取決於伺服器重新開機的速度，以及 Active Directory 和 DNS 複寫時間。

## <a name="post-migration-operations"></a>遷移後作業

在遷移伺服器或叢集之後，請評估環境中是否有可能的遷移後作業： 

- **為現已解除委任的來源伺服器建立方案**。 儲存體遷移服務會使用切換程式，讓目的地伺服器採用來源伺服器的身分識別，變更來源的名稱和 Ip，讓使用者和應用程式無法再存取它。 但是，它不會關閉或改變來源伺服器的內容。 您應建立解除委任來源伺服器的計畫。 建議您將來源保持在最少兩周的時間，以避免遺失使用中的資料，以便在不需要離線備份還原的情況下，輕鬆地取出檔案。 在那段時間之後，我們建議將伺服器關閉一段時間，使其仍可供資料抓取，但不再耗用操作或電源資源。 在那段時間之後，請執行伺服器的最後一次完整備份，然後評估它是否為實體伺服器或刪除虛擬機器時的重新調整用途。      
- **在新的目的地伺服器上重新發出憑證**。 在目的地伺服器上線但尚未剪下的時間，憑證可能已透過自動註冊或其他程式發行給它。 重新命名 Windows Server 並不會自動變更或重新發行現有的憑證，因此現有的憑證可能會在轉換之前包含伺服器的名稱。 您應該檢查該伺服器上現有的憑證，並視需要重新發出新的憑證。   

## <a name="additional-references"></a>其他參考

- [儲存體遷移服務總覽](overview.md)
- [儲存體遷移服務的常見問題 (常見問題) ](faq.md)
- [規劃 Azure 檔案同步部署](/azure/storage/files/storage-sync-files-planning)
