---
title: 連線要求原則
description: 本主題概要說明 Windows Server 2016 中的網路原則伺服器連線要求原則。
manager: brianlic
ms.topic: article
ms.assetid: 4ec45e0c-6b37-4dfb-8158-5f40677b0157
ms.author: lizross
author: eross-msft
ms.date: 08/07/2020
ms.openlocfilehash: a4fc6b2e7342f59f971ee42848f75e6598c1c263
ms.sourcegitcommit: 40905b1f9d68f1b7d821e05cab2d35e9b425e38d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/06/2021
ms.locfileid: "97947794"
---
# <a name="connection-request-policies"></a>連線要求原則

>適用於：Windows Server (半年度管道)、Windows Server 2016

您可以使用本主題來瞭解如何使用 NPS 連線要求原則，將 NPS 設定為 RADIUS 伺服器、RADIUS proxy 或兩者。

>[!NOTE]
>除了本主題之外，還提供下列連接要求原則檔。
> - [設定連線要求原則](nps-crp-configure.md)
> - [設定遠端 RADIUS 伺服器群組](nps-crp-rrsg-configure.md)

連線要求原則是一組條件和設定，可讓網路系統管理員指定哪些遠端驗證撥入消費者服務 (RADIUS) 伺服器會執行連線要求的驗證與授權，而 NPS) 會從 RADIUS 用戶端接收執行網路原則 (伺服器的伺服器。 您可以設定連線要求原則指定哪些 RADIUS 伺服器用於 RADIUS 帳戶處理。

您可以建立連線要求原則，以便在本機處理從 RADIUS 用戶端傳送的一些 RADIUS 要求訊息 (NPS 作為 RADIUS 伺服器) 和其他類型的訊息轉送到另一部 RADIUS 伺服器， (NPS 作為 RADIUS proxy) 使用。

使用連線要求原則時，您可以根據下列因素，將 NPS 作為 RADIUS 伺服器或 RADIUS proxy 使用：

- 一天當中的時間與一週中的一天
- 連線要求中的領域名稱
- 要求的連線類型
- RADIUS 用戶端的 IP 位址

只有當內送訊息的設定至少符合 NPS 上設定的其中一個連線要求原則時，NPS 才會處理或轉送 RADIUS Access-Request 訊息。

如果原則設定相符，且原則要求 NPS 必須處理訊息，NPS 會作為 RADIUS 伺服器，並驗證和授權連線要求。 如果原則設定相符，且原則要求 NPS 轉送訊息，NPS 會作為 RADIUS proxy，並將連線要求轉送到遠端 RADIUS 伺服器進行處理。

如果連入 RADIUS Access-Request 訊息的設定至少與一個連線要求原則不符，Access-Reject 訊息就會傳送到 RADIUS 用戶端，而嘗試連線到網路的使用者或電腦會被拒絕存取。

## <a name="configuration-examples"></a>組態範例

下列設定範例會示範如何使用連線要求原則。

### <a name="nps-as-a-radius-server"></a>做為 RADIUS 伺服器的 NPS

預設的連線要求原則是唯一已設定的原則。 在此範例中，NPS 設定為 RADIUS 伺服器，而且所有連線要求都是由本機 NPS 處理。 NPS 可以驗證和授權其帳戶位於 NPS 網域網域和受信任網域中的使用者。


### <a name="nps-as-a-radius-proxy"></a>做為 RADIUS Proxy 的 NPS

會刪除預設連線要求原則，並建立兩個新的連線要求原則，將要求轉送到兩個不同網域。 在此範例中，NPS 被設定為 RADIUS Proxy。 NPS 不會處理本機伺服器上的任何連線要求。 而是將連線要求轉送到 NPS 或其他 RADIUS 伺服器，這些伺服器被設定為遠端 RADIUS 伺服器群組的成員。


### <a name="nps-as-both-radius-server-and-radius-proxy"></a>NPS 做為 RADIUS 伺服器及 RADIUS Proxy

除了預設的連線要求原則之外，還會建立新的連線要求原則，將連線要求轉送到不受信任網域中的 NPS 或其他 RADIUS 伺服器。 在此範例中，Proxy 原則會顯示在原則排序清單中的第一個。 如果連線要求符合 Proxy 原則，會將連線要求轉送到遠端 RADIUS 伺服器群組中的 RADIUS 伺服器。 如果連線要求不符合 Proxy 原則，但符合預設的連線要求原則，NPS 會在本機伺服器上處理連線要求。 如果連線要求不符合任一原則，就會被捨棄。

### <a name="nps-as-radius-server-with-remote-accounting-servers"></a>NPS 做為具有遠端帳戶處理伺服器的 RADIUS 伺服器

在此範例中，本機 NPS 未設定為執行帳戶處理，且預設連線要求原則已修訂，以將 RADIUS 帳戶處理訊息轉送到遠端 RADIUS 伺服器群組中的 NPS 或其他 RADIUS 伺服器。 雖然帳戶處理訊息是轉送的，但不會轉送驗證和授權訊息，而本機 NPS 會針對本機網域和所有受信任的網域執行這些功能。


### <a name="nps-with-remote-radius-to-windows-user-mapping"></a>NPS 具有 Windows 使用者對應的遠端 RADIUS

在此範例中，NPS 扮演每個連線要求的 RADIUS 伺服器與 RADIUS Proxy，將驗證要求轉送到遠端 RADIUS 伺服器，而使用本機 Windows 使用者帳戶進行授權。 藉由設定 [Windows 使用者對應的遠端 RADIUS] 屬性做為連線要求原則的條件，可以實作此設定。 (此外，必須在本機建立名稱與遠端使用者帳戶相同的使用者帳戶，遠端 RADIUS 伺服器對此帳戶執行驗證。)

## <a name="connection-request-policy-conditions"></a>連線要求原則條件

連線要求原則條件是一或多個 RADIUS 屬性，與連入 RADIUS Access-Request 訊息的屬性相比較。 如果有多重條件，連線要求訊息與連線要求原則中的所有條件都必須相符，NPS 才能強制此原則。


下列是可在連線要求原則中設定的可用條件屬性。

### <a name="connection-properties-attribute-group"></a>連接屬性屬性群組

[連線內容] 屬性群組包含下列屬性。

- **框架通訊協定**。 用來指定連入封包的框架類型。 範例有點對點通訊協定 (PPP)  (PPP) 、序列線路網際網路通訊協定 (單) 、幀轉送和 X. 25。
- **服務類型**。 用來指定所要求的服務類型。 範例包含已框架處理 (例如 PPP 連線) 與登入 (例如 Telnet 連線)。 如需 RADIUS 服務類型的相關資訊，請參閱 RFC 2865＜遠端驗證撥入使用者服務 (RADIUS)＞。
- 通道 **類型**。 用來指定要求用戶端所建立的通道類型。 通道類型包括「點對點通道通訊協定」(PPTP) 和「第二層通道通訊協定」(L2TP)。

### <a name="day-and-time-restrictions-attribute-group"></a>日期和時間限制屬性群組

[日期和時間限制] 屬性群組包含 [日期和時間限制] 屬性。 利用此屬性，您可以指定一天當中的時間與一週中的一天進行連線嘗試。 日期和時間相對於 NPS 的日期和時間。

### <a name="gateway-attribute-group"></a>閘道屬性群組

[閘道] 屬性群組包含下列屬性。

- **呼叫的工作站識別碼**。 用來指定網路存取伺服器的電話號碼。 此屬性是字元字串。 您可以使用模式比對語法指定區碼。
- **NAS 識別碼**。 用來指定網路存取伺服器的名稱。 此屬性是字元字串。 您可以使用模式比對語法指定 NAS 識別碼。
- **NAS IPv4 位址**。 用來指派網路存取伺服器 (RADIUS 用戶端) 的網際網路通訊協定第 4 版 (IPv4) 位址。 此屬性是字元字串。 您可以使用模式比對語法指定 IP 網路。
- **NAS IPv6 位址**。 用來指定網路存取伺服器 (RADIUS 用戶端) 的網際網路通訊協定第 6 版 (IPv6) 位址。 此屬性是字元字串。 您可以使用模式比對語法指定 IP 網路。
- [ **NAS 埠類型**]。 用來指定存取用戶端使用的媒體類型。 例如，類比電話線路 (稱為「非同步 ) 」、「整合式服務數位網路」 (ISDN) 、通道或虛擬私人網路 (Vpn) 、IEEE 802.11 無線和乙太網路交換器。

### <a name="machine-identity-attribute-group"></a>電腦識別碼屬性群組

[電腦識別碼] 屬性群組包含 [電腦識別碼] 屬性。 您可以使用這個屬性來指定在原則中識別用戶端的方法。

### <a name="radius-client-properties-attribute-group"></a>RADIUS 用戶端屬性屬性群組

[RADIUS 用戶端內容] 屬性群組包含下列屬性。

- **呼叫工作站識別碼**。 用來指定呼叫者 (存取用戶端) 使用的電話號碼。 此屬性是字元字串。 您可以使用模式比對語法指定區碼。  在 802.1 x 驗證中，MAC 位址通常會填入，並且可與用戶端進行比對。  當連線要求原則設定為「接受使用者而不驗證認證」時，此欄位通常用於 Mac 位址略過案例。
- **用戶端易記名稱**。 用來指定要求驗證的 RADIUS 用戶端電腦的名稱。 此屬性是字元字串。 您可以使用模式比對語法指定用戶端名稱。
- **用戶端 IPv4 位址**。 用來指定網路存取伺服器 (RADIUS 用戶端) 的 IPv4 位址。 此屬性是字元字串。 您可以使用模式比對語法指定 IP 網路。
- **用戶端 IPv6 位址**。 用來指定網路存取伺服器 (RADIUS 用戶端) 的 IPv6 位址。 此屬性是字元字串。 您可以使用模式比對語法指定 IP 網路。
- **用戶端廠商**。 用來指定要求驗證的網路存取伺服器的廠商。 執行 [路由及遠端存取] 服務的電腦是 Microsoft NAS 製造商。 您可以使用此屬性設定不同 NAS 製造商的個別原則。 此屬性是字元字串。 您可以使用模式比對語法。

### <a name="user-name-attribute-group"></a>使用者名稱屬性群組

[使用者名稱] 屬性群組包含 [使用者名稱] 屬性。 藉由使用此屬性，您可以指定使用者名稱或使用者名稱的一部分，而這些名稱必須符合 RADIUS 訊息中存取用戶端所提供的使用者名稱。 此屬性是字元字串，通常包含領域名稱與使用者帳戶名稱。 您可以使用模式比對語法指定使用者名稱。

## <a name="connection-request-policy-settings"></a>連線要求原則設定

連線要求原則設定是一組內容，可套用到連入 RADIUS 訊息。 設定包含下列屬性群組。

- 驗證
- 會計
- 屬性操作
- 轉寄要求
- 進階

下列各節提供有關這些設定的其他詳細資料。

### <a name="authentication"></a>驗證

藉由使用此設定，您可以覆寫所有網路原則中設定的驗證設定，也可以指定連接到網路所需的驗證方法和類型。

>[!IMPORTANT]
>如果您在連線要求原則中設定的驗證方法，比您在網路原則中設定的驗證方法更安全，則會覆寫您在網路原則中設定的更安全驗證方法。 例如，如果您有一種網路原則需要使用受保護的可延伸驗證 Protocol-Microsoft 挑戰交握驗證通訊協定第2版 \( PEAP-ms-chap v2 \) （這是安全無線的密碼型驗證方法），而且您也設定連線要求原則以允許未經驗證的存取，結果就是不需要使用 PEAP-ms-chap v2 來驗證用戶端。 在此範例中，所有連線到網路的用戶端都會被授與未驗證的存取權。

### <a name="accounting"></a>會計

藉由使用此設定，您可以設定連線要求原則，將帳戶處理資訊轉送到遠端 RADIUS 伺服器群組中的 NPS 或其他 RADIUS 伺服器，讓遠端 RADIUS 伺服器群組執行帳戶處理。

>[!NOTE]
>如果您有多個 RADIUS 伺服器，而且想要將所有伺服器的帳戶處理資訊存放在單一集中的 RADIUS 帳戶處理資料庫中，可以在每個 RADIUS 伺服器的原則中使用連線要求原則帳戶處理設定，將帳戶處理資料從所有伺服器轉送到單一 NPS，或轉送到指定做為帳戶處理伺服器的其他 RADIUS 伺服器。

連線要求原則帳戶處理設定的功能，與本機 NPS 的帳戶處理設定無關。 換句話說，如果您設定本機 NPS 將 RADIUS 帳戶處理資訊記錄到本機檔案或 Microsoft SQL Server 資料庫，無論您是否設定連線要求原則，將帳戶處理訊息轉送到遠端 RADIUS 伺服器群組，都將會這麼做。

如果您想要從遠端（而不是在本機）記錄的帳戶處理資訊，則必須將本機 NPS 設定為不執行帳戶處理，同時也會在連線要求原則中設定帳戶處理，以將計量資料轉送到遠端 RADIUS 伺服器群組。

### <a name="attribute-manipulation"></a>屬性操作

您可以設定一組尋找和取代規則，以操作下列其中一個屬性的文字字串。

- 使用者名稱
- 被呼叫的工作站識別碼
- 被呼叫的工作站識別碼

在 RADIUS 訊息之前發生的其中一個前述屬性的尋找和取代規則處理，受制於驗證和帳戶處理設定。 屬性操作規則只適用於單一屬性。 您無法為每個屬性設定屬性操作規則。 此外，您可操作的屬性清單是靜態清單；您無法新增可用的屬性清單進行操作。

>[!NOTE]
>使用 MS-CHAP v2 驗證通訊協定時，如果使用連線要求原則轉送 RADIUS 訊息，就無法操作 [使用者名稱] 屬性。 唯一的例外狀況是使用反斜線 (\) 字元，而且操作只會影響其左邊的資訊。 反斜線字元通常用來指出網域名稱 (反斜線字元左邊的資訊) 及網域中的使用者帳戶名稱 (反斜線字元右邊的資訊)。 在此情況下，只允許修改或取代網域名稱的屬性操作規則。

如需如何在 [使用者名稱] 屬性中操作領域名稱的範例，請參閱在 [NPS 中使用正則運算式](nps-crp-reg-expressions.md)主題中的「在使用者名稱屬性中操作領域名稱的範例」一節。

### <a name="forwarding-request"></a>轉寄要求

您可以設定下列用於 RADIUS Access-Request 訊息的轉寄要求選項：

- **驗證此伺服器上的要求**。 使用此設定時，NPS 會使用 Windows NT 4.0 網域、Active Directory 或本機安全性帳戶管理員 (SAM) 使用者帳戶資料庫來驗證連接要求。 此設定也會指定在 NPS 中設定的相符網路原則及使用者帳戶的撥入內容，由 NPS 用來授權連線要求。 在此情況下，NPS 設定為以 RADIUS 伺服器的形式執行。

- 將 **要求轉寄至下列遠端 RADIUS 伺服器群組**。 藉由使用此設定，NPS 會將連線要求轉送到您指定的遠端 RADIUS 伺服器群組。 如果 NPS 收到對應至 Access-Request 訊息的有效 Access-Accept 訊息，則會將連線嘗試視為已驗證和已授權。 在此情況下，NPS 會作為 RADIUS proxy。

- **接受使用者而不驗證認證**。 藉由使用此設定，NPS 不會驗證嘗試連線到網路的使用者身分識別，且 NPS 不會嘗試確認使用者或電腦是否具有連線到網路的許可權。 當 NPS 被設定為允許未驗證存取時，NPS 會在接收連線要求時立即傳送 Access-Accept 訊息到 RADIUS 用戶端，而使用者或電腦被授與網路存取權。 這項設定可用於某些強制通道類型，其中存取用戶端會在驗證使用者認證之前通道。

>[!NOTE]
>當存取用戶端的驗證通訊協定為 MS-CHAP v2 或可延伸驗證 Protocol-Transport 層安全性 (EAP-TLS) （兩者都提供相互驗證）時，就無法使用此驗證選項。 在相互驗證中，存取用戶端證明它是驗證服務器 (NPS) 的有效存取用戶端，而驗證服務器證明它是存取用戶端的有效驗證服務器。 使用此驗證選項時，會傳回 Access-Accept 訊息。 不過，驗證服務器不會提供對存取用戶端的驗證，而且相互驗證會失敗。

如需如何使用正則運算式來建立路由規則，將具有指定領域名稱的 RADIUS 訊息轉送到遠端 RADIUS 伺服器群組的範例，請參閱在 [NPS 中使用正則運算式](nps-crp-reg-expressions.md)主題中的「proxy 伺服器的 radius 訊息轉送範例」一節。

### <a name="advanced"></a>進階

您可以設定進階內容指定此系列 RADIUS 屬性，這些屬性可以：

- 當 NPS 做為 RADIUS 驗證或帳戶處理伺服器使用時，新增至 RADIUS 回應訊息。 當網路原則與連線要求原則都指定屬性時，在 RADIUS 回應訊息中傳送的屬性是兩組屬性的組合。
- 當 NPS 做為 RADIUS 驗證或帳戶處理 proxy 使用時，新增至 RADIUS 訊息。 如果屬性已經在被轉送的訊息中，會以連線要求原則中指定的屬性值取代。

此外，您可以在 [ **Advanced** ] 類別的 [連線要求原則設定] 索引標籤上 **設定** 的一些屬性，提供特殊的功能。 例如，當您想要分割兩個使用者帳戶資料庫之間的連接要求驗證和授權時，您可以設定 [ **Windows 使用者對應的遠端 RADIUS** ] 屬性。

[ **Windows 使用者對應的遠端 RADIUS** ] 屬性指定 windows 授權是由遠端 radius 伺服器驗證的使用者所進行。 換句話說，遠端 RADIUS 伺服器會針對遠端使用者帳戶資料庫中的使用者帳戶執行驗證，但本機 NPS 會對本機使用者帳戶資料庫中的使用者帳戶授權連接要求。 當您想要允許訪客存取網路時，這個選項非常有用。

例如，來自夥伴組織的訪客可以由自己的夥伴組織 RADIUS 伺服器進行驗證，然後使用您組織中的 Windows 使用者帳戶來存取網路上 (LAN) 的來賓區域網路。

提供特殊功能的其他屬性包括：

- **Ms-隔離-IPFilter 和 ms-隔離-會話超時**。 使用 [路由及遠端存取] VPN 部署以部署網路存取隔離控制 (NAQC) 時可使用這些屬性 。
- **Passport-使用者對應-UPN-尾碼**。 此屬性可讓您使用 Windows Live™ ID 使用者帳戶認證以驗證連線要求。
- 通道 **-標記**。 此屬性指定 VLAN 識別碼，它是在部署虛擬區域網路 (VLAN) 時，NAS 所指派連線的編號。

## <a name="default-connection-request-policy"></a>預設連線要求原則

預設連線要求原則是在安裝 NPS 時建立。 此原則具有下列設定。

- 未設定 [驗證]。
- 未設定 [帳戶處理] 將帳戶處理資訊轉送到遠端 RADIUS 伺服器群組。
- 未使用屬性操作規則設定 [屬性]，此規則將連線要求轉送到遠端 RADIUS 伺服器群組。
- 已設定轉送要求，以便在本機 NPS 上驗證和授權連線要求。
- 未設定 [進階] 屬性。

預設連線要求原則使用 NPS 做為 RADIUS 伺服器。 若要設定執行 NPS 的伺服器做為 RADIUS Proxy，您還必須設定遠端 RADIUS 伺服器群組。 當您使用 [新增連線要求原則] 嚮導建立新的連線要求原則時，可以建立新的遠端 RADIUS 伺服器群組。 您可以刪除預設連線要求原則，或確認預設連線要求原則是 NPS 最後處理的原則，並將它放在原則的排序清單中。

>[!NOTE]
>如果 NPS 和遠端存取服務是安裝在同一部電腦上，而且遠端存取服務是針對 Windows 驗證和帳戶處理設定的，則可能會將遠端存取驗證和帳戶處理要求轉送到 RADIUS 伺服器。 當遠端存取驗證和帳戶處理要求符合設定為將它們轉寄到遠端 RADIUS 伺服器群組的連線要求原則時，就會發生這種情況。
