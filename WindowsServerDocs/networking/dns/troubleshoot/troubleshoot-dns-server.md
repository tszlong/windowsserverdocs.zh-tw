---
title: 疑難排解 DNS 伺服器
description: 本文介紹如何針對伺服器端的 DNS 問題進行疑難排解。
manager: dcscontentpm
ms.topic: article
ms.author: delhan
ms.date: 8/8/2019
author: Deland-Han
ms.openlocfilehash: c817a1b5763f04da8e66d97ce0e47db53a3fe205
ms.sourcegitcommit: 8e330f9066097451cd40e840d5f5c3317cbc16c2
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/19/2020
ms.locfileid: "97696999"
---
# <a name="troubleshooting-dns-servers"></a>對 DNS 伺服器進行疑難排解

本文討論如何針對 DNS 伺服器上的問題進行疑難排解。

## <a name="check-ip-configuration"></a>檢查 IP 設定

1. `ipconfig /all`在命令提示字元中執行，並驗證 IP 位址、子網路遮罩和預設閘道。

2. 檢查 DNS 伺服器是否有權取得查閱的名稱。 如果是，請參閱 [檢查是否有授權資料的問題](#checking-for-problems-with-authoritative-data)。

3. 執行下列命令：

   ```cmd
   nslookup <name> <IP address of the DNS server>
   ```
   例如：
   ```cmd
   nslookup app1 10.0.0.1
   ```
   如果您收到失敗或超時回應，請參閱 [檢查遞迴問題](#checking-for-recursion-problems)。

4. 清除解析程式快取。 若要這樣做，請在系統管理命令提示字元視窗中執行下列命令：

   ```cmd
   dnscmd /clearcache
   ```
   或者，在系統管理 PowerShell 視窗中，執行下列 Cmdlet：
   ```powershell
   Clear-DnsServerCache
   ```

5. 重複步驟3。

## <a name="check-dns-server-problems"></a>檢查 DNS 伺服器問題

### <a name="event-log"></a>事件記錄檔

檢查下列記錄以查看是否有任何記錄的錯誤：

- 應用程式

- 系統

- DNS 伺服器

### <a name="test-by-using-nslookup-query"></a>使用 nslookup 查詢進行測試

執行下列命令，並檢查是否可從用戶端電腦連線到 DNS 伺服器。

```cmd
nslookup <client name> <server IP address>
```

- 如果解析程式傳回用戶端的 IP 位址，則伺服器沒有任何問題。

- 如果解析程式傳回「伺服器失敗」或「拒絕查詢」回應，則區域可能已暫停，或者伺服器可能多載。 您可以在 DNS 主控台中勾選 [區域內容] 的 [一般] 索引標籤，以瞭解其是否已暫停。

如果解析程式傳回「要求伺服器超時」或「沒有來自伺服器的回應」回應，則 DNS 服務可能不在執行中。 嘗試在伺服器上的命令提示字元中輸入下列命令，以重新開機 DNS 伺服器服務：

```cmd
net start DNS
```

如果此問題發生在服務執行中，伺服器可能不會接聽您在 nslookup 查詢中使用的 IP 位址。 在 DNS 主控台的 [伺服器屬性] 頁面的 [ **介面** ] 索引標籤上，系統管理員可以限制 dns 伺服器只在選取的位址上接聽。 如果 DNS 伺服器已設定為將服務限制為其所設定 IP 位址的特定清單，則用來聯繫 DNS 伺服器的 IP 位址可能不在清單中。 您可以嘗試在清單中使用不同的 IP 位址，或將 IP 位址新增至清單。

在罕見的情況下，DNS 伺服器可能會有 advanced 安全性或防火牆設定。 如果伺服器位於另一個只能透過轉送主機連線的網路 (例如封包篩選路由器或 proxy 伺服器) ，則 DNS 伺服器可能會使用非標準埠來接聽和接收用戶端要求。 根據預設，nslookup 會將查詢傳送至 UDP 埠53上的 DNS 伺服器。 因此，如果 DNS 伺服器使用任何其他埠，nslookup 查詢將會失敗。 如果您認為這可能是問題，請檢查中繼篩選是否刻意用來封鎖已知 DNS 埠上的流量。 如果不是，請嘗試修改防火牆上的封包篩選器或連接埠規則，以允許 UDP/TCP 埠53上的流量。

## <a name="checking-for-problems-with-authoritative-data"></a>檢查是否有授權資料的問題

檢查傳回錯誤回應的伺服器是否為區域的主伺服器 (區域的標準主伺服器，或使用 Active Directory 整合以載入區域) 的伺服器，或是裝載區域次要複本的伺服器。

### <a name="if-the-server-is-a-primary-server"></a>如果伺服器是主伺服器

當使用者在區域中輸入資料時，問題可能是使用者錯誤所造成。 或者，它可能是因為有影響 Active Directory 複寫或動態更新的問題所造成。

### <a name="if-the-server-is-hosting-a-secondary-copy-of-the-zone"></a>如果伺服器裝載區域的次要複本

1. 檢查主伺服器上的區域 (伺服器從中提取區域傳輸) 。

   > [!NOTE]
   >您可以在 DNS 主控台中檢查次要區域的內容，以判斷哪一部伺服器是主伺服器。

   如果主伺服器上的名稱不正確，請移至步驟4。

2. 如果主伺服器上的名稱正確，請檢查主伺服器的序號是否小於或等於次要伺服器上的序號。 如果是，請修改主伺服器或次要伺服器，使主伺服器上的序號大於次要伺服器上的序號。

3. 在次要伺服器上，從 DNS 主控台內或執行下列命令來強制區域轉送：

   ```cmd
   dnscmd /zonerefresh <zone name>
   ```

   例如，如果區域是 corp.contoso.com，請輸入： `dnscmd /zonerefresh corp.contoso.com` 。

4. 再次檢查次要伺服器，以查看是否已正確傳輸該區域。 如果沒有，您可能有區域轉送問題。 如需詳細資訊，請參閱 [區域轉送問題](#zone-transfer-problems)。

5. 如果區域已正確傳輸，請檢查資料是否現在正確。 如果不是，主要區域中的資料不正確。 當使用者在區域中輸入資料時，問題可能是使用者錯誤所造成。 或者，它可能是因為有影響 Active Directory 複寫或動態更新的問題所造成。

## <a name="checking-for-recursion-problems"></a>檢查遞迴問題

遞迴查詢的路徑中使用的所有 DNS 伺服器都必須能夠回應和轉寄正確的資料，遞迴才能順利運作。 如果無法這麼做，遞迴查詢可能會因為下列任何原因而失敗：

- 查詢會在可以完成之前完成。

- 在查詢期間使用的伺服器無法回應。

- 在查詢期間使用的伺服器會提供不正確的資料。

在原始查詢中使用的伺服器上開始疑難排解。 檢查 DNS 主控台中伺服器 **屬性的 [轉寄站] 索引** 標籤，檢查此伺服器是否將查詢轉送到另一部伺服器。 如果已選取 [ **啟用** 轉寄站] 核取方塊，而且列出一或多部伺服器，則此伺服器會轉寄查詢。

如果此伺服器將查詢轉送到另一部伺服器，請檢查影響此伺服器轉送查詢之伺服器的問題。 若要檢查是否有問題，請參閱 [檢查 DNS 伺服器問題](#check-dns-server-problems)。 當該區段指示您在用戶端上執行工作時，請改為在伺服器上執行工作。

如果伺服器狀況良好且可以轉寄查詢，請重複此步驟，並檢查此伺服器轉送查詢的伺服器。

如果此伺服器不會將查詢轉送到另一部伺服器，請測試此伺服器是否可以查詢根功能變數名稱伺服器。 若要這樣做，請執行下列命令：

```cmd
nslookup
server <IP address of server being examined>
set q=NS
 ```

- 如果解析程式傳回根功能變數名稱伺服器的 IP 位址，您可能會在根伺服器與您嘗試解析的名稱或 IP 位址之間有中斷的委派。 遵循 [測試中斷的委派](#test-a-broken-delegation) 程式，判斷您的委派是否中斷。

- 如果解析程式傳回「要求伺服器超時」回應，請檢查根提示是否指向正常運作的根伺服器。 若要這樣做，請使用 [來查看目前的根提示](#to-view-the-current-root-hints) 程式。 如果根提示確實指向正常運作的根伺服器，您可能會有網路問題，或伺服器可能會使用可防止解析程式查詢伺服器的 advanced firewall 設定，如 [檢查 DNS 伺服器問題](#check-dns-server-problems) 一節中所述。 遞迴超時預設值也可能太短。

### <a name="test-a-broken-delegation"></a>測試中斷的委派

藉由查詢有效的根功能變數名稱伺服器，開始執行下列程式中的測試。 此測試會引導您完成從根查詢所有 DNS 伺服器到您要測試的伺服器是否有中斷委派的程式。

1. 在您要測試之伺服器上的命令提示字元中，輸入下列命令：

   ```cmd
   nslookup
   server <server IP address>
   set norecursion
   set querytype= <resource record type>
   <FQDN>
   ```
   > [!NOTE]
   >資源記錄類型是您在原始查詢中查詢的資源記錄類型，FQDN 是您查詢的 FQDN， (以句點) 結束。

2. 如果回應包含委派伺服器的「NS」和「A」資源記錄清單，請針對每部伺服器重複步驟1，並使用來自「A」資源記錄的 IP 位址作為伺服器 IP 位址。

   - 如果回應不包含「NS」資源記錄，您就會有中斷的委派。

   - 如果回應包含「NS」資源記錄，但沒有「A」資源記錄，請輸入 **set 遞迴**，然後個別查詢「ns」記錄中列出的伺服器「a」資源記錄。 如果您在區域中的每個 NS 資源記錄都找不到至少一個「A」資源記錄的有效 IP 位址，則會有中斷的委派。

3. 如果您判斷有損毀的委派，請在父區域中新增或更新「A」資源記錄，藉由為委派區域的正確 DNS 伺服器使用有效的 IP 位址來修正此問題。

### <a name="to-view-the-current-root-hints"></a>若要查看目前的根目錄提示

1. 啟動 DNS 主控台。

2. 新增或連接到未通過遞迴查詢的 DNS 伺服器。

3. 以滑鼠右鍵按一下伺服器，然後選取 [ **屬性**]。

4. 按一下 [根提示]。

檢查根伺服器的基本連線能力。

- 如果根目錄提示的設定正確無誤，請確認用於失敗名稱解析的 DNS 伺服器可以透過 IP 位址來 ping 根伺服器。

- 如果根伺服器未依 IP 位址回應 ping，則根伺服器的 IP 位址可能已變更。 不過，查看根伺服器的重新設定並不常見。

## <a name="zone-transfer-problems"></a>區域轉送問題

執行下列檢查：

- 檢查主要和次要 DNS 伺服器的事件檢視器。

- 檢查主伺服器，查看是否拒絕傳送安全性傳送。

- 在 DNS 主控台中，核取 [區域內容] 的 [ **區域傳輸** ] 索引標籤。 如果伺服器限制區域傳輸到伺服器清單，例如 [區域] 屬性的 [ **名稱伺服器** ] 索引標籤上所列的伺服器，請確定次要伺服器位於該清單。 請確定伺服器已設定為傳送區域傳輸。

- 遵循 [ [檢查 DNS 伺服器問題](#check-dns-server-problems) ] 一節中的步驟，檢查主伺服器是否有問題。 當系統提示您在用戶端上執行工作時，請改在次要伺服器上執行工作。

- 檢查次要伺服器是否正在執行其他 DNS 伺服器，例如 BIND。 如果是，問題可能是下列其中一個原因所造成：

  - Windows 主伺服器可能設定為傳送快速區域傳輸，但協力廠商次要伺服器可能不支援快速區域傳輸。 如果發生這種情況，請在伺服器內容的 [ **Advanced** ] 索引標籤上選取 [**啟用** 系結次要] 核取方塊，以在主伺服器上停用從 DNS 主控台進行的快速區域轉送。

  - 如果 Windows 伺服器上的正向對應區域包含記錄類型 (例如，次要伺服器不支援的 SRV 記錄) ，則次要伺服器可能會在提取區域時發生問題。

檢查主伺服器是否正在執行其他 DNS 伺服器，例如 BIND。 若是如此，主伺服器上的區域可能會包含 Windows 無法辨識的不相容資源記錄。

如果主要或次要伺服器正在執行另一部 DNS 伺服器，請檢查這兩部伺服器，以確定它們支援相同的功能。 您可以在伺服器的 [內容] 頁面的 [ **Advanced** ] 索引標籤上，檢查 DNS 主控台中的 Windows server。 除了 [啟用系結次要資料庫] 方塊之外，此頁面還包含 [ **名稱檢查** ] 下拉式清單。 這可讓您針對 DNS 名稱中的字元，選取強制執行嚴格的 RFC 合規性。

