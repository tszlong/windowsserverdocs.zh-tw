---
title: 部署 Hyper-V 複本
ms.technology: compute-hyper-v
description: 提供設定複本、測試容錯移轉，以及進行第一次複寫的指示。
ms.prod: windows-server
manager: dongill
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
author: kbdazure
ms.author: kathydav
ms.date: 10/10/2016
ms.openlocfilehash: c24b26617f7174632bc39842afc9e83843e7673b
ms.sourcegitcommit: acfdb7b2ad283d74f526972b47c371de903d2a3d
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 08/05/2020
ms.locfileid: "87769686"
---
# <a name="set-up-hyper-v-replica"></a>部署 Hyper-V 複本

>適用於：Windows Server 2016

Hyper-V 複本是 Hyper-V 角色中不可或缺的一部分。 它會藉由將虛擬機器從一部 Hyper-v 主機伺服器複寫至另一部，以確保您的工作負載可供使用，藉此提供嚴重損壞修復策略。  Hyper-v 複本會建立一份即時虛擬機器到複本離線虛擬機器的複本。 請注意：

-   **Hyper-v 主機**：主要和次要主機伺服器可以實體共置，或位於不同的地理位置，並透過 WAN 連結進行複寫。 Hyper-v 主機可以是獨立、叢集或兩者的混合。 伺服器之間沒有 Active Directory 相依性，而且它們不需要是網域成員。

-   複寫**和變更追蹤**：當您啟用特定虛擬機器的 Hyper-v 複本時，初始複寫會在次要主機伺服器上建立相同的複本虛擬機器。 之後，Hyper-v 複本變更追蹤就會建立並維護一個記錄檔，以在虛擬機器 VHD 上捕獲變更。 記錄檔會根據複寫頻率設定，以相反的順序播放至複本 VHD。 這表示最新的變更會以非同步方式儲存和複寫。 複寫可以透過 HTTP 或 HTTPS 進行。

-   **擴充的 (連結) **複寫：這可讓您將虛擬機器從主要主機複寫至次要主機，然後將次要主機複寫至第三個主機。 請注意，您無法將主要主機直接複寫到第二個和第三個。

    這項功能讓 Hyper-v 複本更健全，以進行嚴重損壞修復，因為萬一發生中斷，您可以從主要和延伸複本進行復原。  如果您的主要和次要位置停止執行，您可以故障切換至擴充複本。 請注意，擴充複本不支援應用程式一致複寫，而且必須使用次要複本所使用的相同 Vhd。

-   **容錯移轉**：如果您的主要 (或在擴充) 位置時的次要複本發生中斷，您可以手動起始測試、規劃或未計畫的容錯移轉。

    | 問題 | 測試 | 已規劃 | 非計劃之中 |
    |--|--|--|--|
    | 我應該在何時執行？ | 確認虛擬機器可以在次要網站中故障切換並啟動<p>適用于測試和訓練 | 在規劃的停機和中斷期間 | 非預期的事件期間 |
    | 是否已建立重複的虛擬機器？ | 是 | 否 | 否 |
    | 其起始位置為何？ | 在複本虛擬機器上 | 在主要機器起始上，在次要機器上完成 | 在複本虛擬機器上 |
    | 我應該執行多久的時間？ | 建議每月一次進行測試 | 每六個月一次，或符合合規性需求 | 只有在主要虛擬機器無法使用時，才會發生嚴重損壞狀況 |
    | 主要虛擬機器是否繼續複寫？ | 是 | 是。 中斷解決時，反向複寫會將變更複寫回主要網站，以便同步處理主要和次要複本。 | 否 |
    | 是否有任何資料遺失？ | 無 | 無。 在容錯移轉之後，Hyper-v 複本會將最後一組追蹤的變更複寫回主要複本，以確保零資料遺失。 | 取決於事件和復原點 |
    | 是否有任何停機時間？ | 無。 這不會影響您的生產環境。 它會在容錯移轉期間建立重複的測試虛擬機器。 容錯移轉完成之後，您會在複本虛擬機器上選取 [**容錯移轉**]，它會自動清除並刪除。 | 計畫中斷的持續時間 | 非計畫中斷的持續時間 |

-   **復原點**：當您設定虛擬機器的複寫設定時，會指定您想要在其中儲存的復原點。 復原點代表可復原虛擬機器的時間快照。 如果您從最近的復原點復原，顯然會遺失較少的資料。 您最多可以存取24小時前的復原點。

## <a name="deployment-prerequisites"></a>部署必要條件
在開始之前，您應該先確認下列事項：

-   **找出需要複寫的 vhd**。 特別的是，包含在容錯移轉之後，複本伺服器快速變更且不會使用之資料的 Vhd （例如分頁檔案磁片）應從複寫中排除，以節省網路頻寬。 記下可以排除的 Vhd。

-   **決定同步處理資料所需的頻率**：複本伺服器上的資料會根據您設定的複寫頻率（ (30 秒、5分鐘或15分鐘的) ）進行同步更新。 您選擇的頻率應考慮下列各項：虛擬機器是否執行具有低 RPO 的重要資料？ 您的頻寬考慮是什麼？  非常重要的虛擬機器顯然需要更頻繁的複寫。

-   **決定如何復原資料**：根據預設，hyper-v 複本只會儲存單一復原點，這會是從主資料庫傳送到次要複本的最新複寫。 不過，如果您想要將資料復原到較早時間點的選項，您可以指定應該儲存額外的復原點， (最多24小時的點) 。 如果您需要額外的復原點，請注意，這需要更多的處理和儲存體資源額外負荷。

-   **找出您要複寫的工作負載**：標準 hyper-v 複本複寫會在容錯移轉之後維持虛擬機器作業系統狀態的一致性，而不是在虛擬機器上執行的應用程式狀態。 如果您想要能夠復原您的工作負載狀態，您可以建立應用程式一致的復原點。 請注意，如果您使用擴充的 (連結) 複寫，則不會在延伸複本網站上提供應用程式一致復原。

-   **決定如何執行虛擬機器資料的初始**複寫：複寫一開始會先轉移虛擬機器的目前狀態。 這個初始狀態可以直接透過現有網路傳送，它可以立即傳送或在您設定的稍後時間傳送。 您也可以使用既有的已還原虛擬機器 (例如，如果您已在複本伺服器上還原較舊的虛擬機器備份，) 做為初始複本。 或者，將初始複本複製到外部媒體，然後再將媒體實體送到複本站台，即可節省網路頻寬。  如果您想要使用預先存在的虛擬機器，請刪除所有與它相關聯的先前快照集。

## <a name="deployment-steps"></a>部署步驟

### <a name="step-1-set-up-the-hyper-v-hosts"></a>步驟1：設定 Hyper-v 主機
在每部伺服器上，您將需要至少兩個具有一或多部虛擬機器的 Hyper-v 主機。 [開始使用 hyper-v](../get-started/Get-started-with-Hyper-V-on-Windows.md)。 您要將虛擬機器複寫到其中的主機伺服器，必須設定為複本伺服器。

1.  在您要將虛擬機器複寫到的伺服器 Hyper-v 設定中，選取 [複寫設定 **] 中的**[啟用這部**電腦做為複本伺服器**]。

2.  您可以透過 HTTP 或加密的 HTTPS 進行複寫。 選取 [**使用 Kerberos (HTTP) ** ] 或 [**使用以憑證為基礎的驗證 (HTTPS**) ]。 根據預設，HTTP 80 和 HTTPS 443 會啟用為複本 Hyper-v 伺服器上的防火牆例外。 如果您變更預設通訊埠設定，您也必須變更防火牆例外。 如果您是透過 HTTPS 進行複寫，則必須選取憑證，而且您應該設定憑證驗證。

3.  針對 [授權]，選取 [**允許從任何已驗證的伺服器**進行複寫]，讓複本伺服器接受來自任何已成功驗證之主伺服器的虛擬機器複寫流量。 選取 **[允許從指定的伺服器**進行複寫]，只接受來自您特別選取之主伺服器的流量。

    針對這兩個選項，您可以指定複寫的 Vhd 應該存放在複本 Hyper-v 伺服器上的位置。

4.  按一下 [確定]**** 或 [套用]****。

### <a name="step-2-set-up-the-firewall"></a>步驟2：設定防火牆
若要允許主要和次要伺服器之間的複寫，流量必須通過 Windows 防火牆 (或任何其他協力廠商防火牆) 。 當您在伺服器上安裝 Hyper-v 角色時，預設會建立 HTTP (80) 和 HTTPS (443) 的例外狀況。 如果您使用的是這些標準埠，只需要啟用規則：

-  若要在獨立主機伺服器上啟用規則：

    1. 開啟 [具有預先安全性的 Windows 防火牆]，然後按一下 [**輸入規則**]。

    2. 若要啟用 HTTP (Kerberos) 驗證，請以滑鼠右鍵按一下 [ **hyper-v 複本 HTTP 接聽程式] ([TCP-In]) **  > **啟用規則]。** 若要啟用以 HTTPS 憑證為基礎的驗證，請以滑鼠右鍵按一下 [ **Hyper-v 複本 HTTPS 接聽程式] ([TCP 傳入) ** > E**啟用 n) 規則**]。

-  若要在 Hyper-v 叢集上啟用規則，請使用 [以**系統管理員身分執行**] 開啟 Windows PowerShell 會話，然後執行下列其中一個命令：

    -   針對 HTTP：`get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`

    -   針對 HTTPS：`get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`

### <a name="enable-virtual-machine-replication"></a>啟用虛擬機器複寫
在您要複寫的每部虛擬機器上執行下列動作：

1.  在 [Hyper-v 管理員] 的**詳細資料**窗格中，按一下虛擬機器加以選取。
    以滑鼠右鍵按一下選取的虛擬機器，然後按一下 [**啟用**複寫] 以開啟 [啟用複寫嚮導]。

2.  在 [在您開始前]**** 頁面，按 [下一步]****。

3.  在 [**指定複本伺服器**] 頁面的 [複本伺服器] 方塊中，輸入複本伺服器的 NETBIOS 或 FQDN。 如果複本伺服器是容錯移轉叢集的一部分，請輸入 Hyper-v 複本代理人的名稱。 按 [下一步] 。

4.  在 [**指定連線參數**] 頁面上，hyper-v 複本會自動抓取您為複本伺服器設定的驗證與埠設定。 如果未抓取值，請檢查伺服器是否設定為複本伺服器，以及它是否已在 DNS 中註冊。 如果必要，請以手動方式輸入設定。

5.  在 [**選擇複寫 vhd** ] 頁面上，確定已選取您要複寫的 vhd，並清除您想要從複寫排除的任何 vhd 的核取方塊。 然後按一下 [下一步]。

6.  在 [**設定複寫頻率**] 頁面上，指定變更應該從主要同步處理到次要複本的頻率。 然後按一下 [下一步]。

7.  在 [**設定其他復原點**] 頁面上，選取您只想要維護最新的復原點，還是要建立其他點。    如果您想要持續復原具有自己的 VSS 寫入器的應用程式和工作負載，建議您選取 [**磁碟區陰影複製服務 (VSS) frequenc**y]，並指定建立應用程式一致快照的頻率。 請注意，Hyper-v VMM 要求者服務必須同時在主要和次要 Hyper-v 伺服器上執行。 然後按一下 [下一步]。

8.  在 [**選擇初始**複寫] 頁面上，選取要使用的初始複寫方法。  透過網路傳送初始複本的預設設定，會將主要虛擬機器組態檔 (.VMCX) 以及您在網路連線上選取的虛擬硬碟檔案 (VHDX 和 VHD) 。 如果您要使用此選項，請驗證網路頻寬可用性。 如果主要虛擬機器已在次要網站上設定為複寫虛擬機器，則選取 **[使用複寫伺服器上的現有虛擬機器作為初始複本**] 可能會很有用。 您可以使用 Hyper-v 匯出來匯出主要虛擬機器，並將它匯入為次要伺服器上的複本虛擬機器。 對於較大的虛擬機器或頻寬限制，您可以選擇在稍後透過網路進行初始複寫，然後設定離峰時間，或將初始複寫資訊當做離線媒體來傳送。

    如果您執行離線複寫，您會使用外部儲存媒體（例如硬碟或 USB 磁片磁碟機），將初始複本傳輸到次要伺服器。 若要這樣做，您必須將外部存放裝置連接到叢集中的主伺服器 (或擁有者節點) 然後當您選取 [使用外部媒體傳送初始複本] 時，您可以在本機或可儲存初始複本的外部媒體上指定位置。  會在複本網站上建立預留位置虛擬機器。 初始複寫完成後，可以將外部儲存體運送到複本網站。 在這裡，您會將外部媒體連線到次要伺服器，或連接到次要叢集的擁有者節點。 接著，您會將初始複本匯入到指定的位置，並將其合併到預留位置虛擬機器。

9. 在 [**完成啟用**複寫] 頁面上，檢查摘要中的資訊，然後按一下 **[完成]。** 虛擬機器資料會根據您選擇的設定進行傳輸。 此時會出現一個對話方塊，指出複寫已成功啟用。

10. 如果您想要設定擴充 (連結) 複寫，請開啟複本伺服器，然後在您要複寫的虛擬機器上按一下滑鼠右鍵。 按一下**Replication**  >  [複寫] [**延伸**複寫]，並指定複寫設定。

## <a name="run-a-failover"></a>執行容錯移轉
完成這些部署步驟之後，您的複寫環境就會啟動並執行。 現在您可以視需要執行容錯移轉。

**測試容錯移轉**：如果您想要執行測試容錯移轉 **，請在**主要虛擬機器上按一下滑鼠右鍵，然後選取 [複寫  >  **測試容錯移轉**]。 選擇最新或其他復原點（如果已設定）。 將會在次要網站上建立並啟動新的測試虛擬機器。 測試完成之後，請選取複本虛擬機器上的 [**停止測試容錯移轉**] 來清除它。 請注意，針對虛擬機器，您一次只能執行一個測試容錯移轉。 [閱讀其他資訊](https://blogs.technet.com/b/virtualization/archive/2012/07/26/types-of-failover-operations-in-hyper-v-replica.aspx)。

**規劃的容錯移轉**：若要執行計畫的容錯移轉，請以滑鼠右鍵按一下主要虛擬機器，**然後選取 [** 複寫  >  **計畫的容錯移轉**] 規劃的容錯移轉會執行必要條件檢查，以確保零資料遺失。 它會在開始容錯移轉之前，檢查主要虛擬機器是否已關閉。 虛擬機器故障後，它會開始將變更複寫回主要網站（如果有的話）。 請注意，若要讓此作業正常執行，應將主伺服器設定為從次要伺服器接收到複寫，或在主要叢集的情況下從 Hyper-v 複本代理程式中進行複寫。 規劃的容錯移轉會傳送最後一組追蹤的變更。 [閱讀其他資訊](https://blogs.technet.com/b/virtualization/archive/2012/07/31/types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover.aspx)。

未**計畫的容錯移轉**：若要執行未規劃的容錯移轉，請以滑鼠右鍵按一下複本虛擬機器，然後從 [hyper-v 管理員] 或 [容錯移轉叢集管理員 **] 選取 [** 複寫未  >  **計畫的容錯移轉** 如果啟用此選項，您可以從最新的復原點或從先前的復原點復原。 容錯移轉之後，請檢查容錯移轉虛擬機器上的所有專案是否如預期般運作，然後按一下複本虛擬機器上的 [**完成**]。 [閱讀其他資訊](https://blogs.technet.com/b/virtualization/archive/2012/08/08/types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover.aspx)。
