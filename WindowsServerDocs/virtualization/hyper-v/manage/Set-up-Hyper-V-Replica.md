---
title: 部署 Hyper-V 複本
description: 提供設定複本、測試容錯移轉和執行第一個複寫的指示。
ms.topic: article
ms.assetid: eea9e996-bfec-4065-b70b-d8f66e7134ac
ms.author: benarm
author: BenjaminArmstrong
ms.date: 10/10/2016
ms.openlocfilehash: f34a44ef1e721d2e217fb7c6dd0915ed87007eda
ms.sourcegitcommit: f86cd62a3d43de656b7b9d8e54118a52fda2753b
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 10/08/2020
ms.locfileid: "91844730"
---
# <a name="set-up-hyper-v-replica"></a>部署 Hyper-V 複本

> 適用於：Windows Server 2016

Hyper-V 複本是 Hyper-V 角色中不可或缺的一部分。 它會藉由將虛擬機器從一部 Hyper-v 主機伺服器複寫到另一部伺服器，讓您的工作負載保持可用，來提供您的嚴重損壞修復策略。  Hyper-v 複本會將即時虛擬機器的複本建立至複本離線虛擬機器。 請注意：

- **Hyper-v 主機**：主要和次要主機伺服器可以實體共置，也可以在不同的地理位置，並透過 WAN 連結進行複寫。 Hyper-v 主機可以是獨立、叢集或兩者的混合。 伺服器之間沒有 Active Directory 相依性，而且它們不需要是網域成員。

- 複寫**和變更追蹤**：當您針對特定虛擬機器啟用 Hyper-v 複本時，初始複寫會在次要主機伺服器上建立相同的複本虛擬機器。 發生這種情況之後，Hyper-v 複本變更追蹤會建立並維護記錄檔，以在虛擬機器 VHD 上捕獲變更。 記錄檔會根據複寫頻率設定，以相反的順序播放至複本 VHD。 這表示最新的變更會以非同步方式儲存和複寫。 複寫可以透過 HTTP 或 HTTPS 來傳送。

- **延伸 (連鎖) **複寫：這可讓您將虛擬機器從主要主機複寫至次要主機，然後將次要主機複寫至第三個主機。 請注意，您無法直接從主要主機複寫到第二個和第三個。

    這項功能讓 Hyper-v 複本更健全，以進行嚴重損壞修復，因為如果發生中斷，您可以從主要和擴展複本復原。  如果主要和次要位置下降，您可以容錯移轉至擴充的複本。 請注意，擴充複本不支援應用程式一致複寫，而且必須使用次要複本所使用的相同 Vhd。

- **容錯移轉**：如果主要 (或次要複本發生中斷，以防擴充) 位置時，您可以手動起始測試、規劃或未規劃的容錯移轉。

    | 問題 | 測試 | 已規劃 | 非計劃之中 |
    |--|--|--|--|
    | 我何時應該執行此作業？ | 確認虛擬機器可以在次要網站中進行容錯移轉並啟動<p>適用于測試和定型 | 在規劃的停機和中斷期間 | 在非預期的事件期間 |
    | 是否已建立重複的虛擬機器？ | 是 | 否 | 否 |
    | 它的起始位置為何？ | 在複本虛擬機器上 | 在主要機器起始上，在次要機器上完成 | 在複本虛擬機器上 |
    | 應該執行的頻率為何？ | 建議您每個月一次進行測試 | 每六個月一次或符合合規性需求 | 只有在主要虛擬機器無法使用時，才會發生損毀的情況 |
    | 主要虛擬機器是否會繼續複寫？ | 是 | 是。 當中斷問題解決時，反向複寫會將變更複寫回主要網站，以便同步處理主要和次要複本。 | 否 |
    | 是否有任何資料遺失？ | 無 | 無。 在容錯移轉之後，Hyper-v 複本會將最後一組追蹤的變更複寫回主要複本，以確保零的資料遺失。 | 取決於事件和復原點 |
    | 是否有任何停機時間？ | 無。 它不會影響您的生產環境。 它會在容錯移轉期間建立重複的測試虛擬機器。 在容錯移轉完成之後，您可以選取複本虛擬機器上的 **容錯移轉** ，它會自動清除並刪除。 | 計畫中斷的持續時間 | 未計畫中斷的持續時間 |

- **復原點**：當您設定虛擬機器的複寫設定時，您會指定要從中儲存的復原點。 復原點代表一段時間的快照集，可讓您復原虛擬機器。 如果您從最近的復原點復原，顯然會遺失較少的資料。 您可以在24小時前存取復原點。

## <a name="deployment-prerequisites"></a>部署必要條件

在開始之前，您應該先確認下列事項：

- **找出需要複寫的 vhd**。 尤其是，包含在容錯移轉之後，複本伺服器快速變更且不使用的資料（例如，分頁檔案磁片）的 Vhd，應從複寫中排除，以節省網路頻寬。 請記下可以排除的 Vhd。

- **決定您需要同步處理資料的頻率**：複本伺服器上的資料會根據您設定的複寫頻率進行同步處理（ (30 秒、5分鐘或15分鐘的) ）。 您選擇的頻率應該考慮下列各項：虛擬機器是否以低 RPO 執行重要資料？ 頻寬有哪些考慮？  您的高關鍵性虛擬機器顯然需要更頻繁的複寫。

- **決定如何復原資料**：根據預設，hyper-v 複本只會儲存單一復原點，這會是從主要複本傳送至次要複本的最新複寫。 但是，如果您想要將資料復原到較早時間點的選項，您可以指定額外的復原點應該儲存 (到最多24小時的點) 。 如果您需要額外的復原點，請注意，這需要更多的處理和儲存資源負擔。

- **找出您要複寫的工作負載**：標準 hyper-v 複本複寫會在容錯移轉之後維持虛擬機器作業系統狀態的一致性，但不會在虛擬機器上執行的應用程式狀態維持一致性。 如果您想要能夠復原您的工作負載狀態，您可以建立應用程式一致的復原點。 請注意，如果您使用擴充的 (連結) 複寫，就無法在擴充複本網站上使用應用程式一致復原。

- **決定如何執行虛擬機器資料的初始**複寫：複寫一開始先傳輸需要傳輸虛擬機器的目前狀態。 這個初始狀態可以直接透過現有網路傳送，它可以立即傳送或在您設定的稍後時間傳送。 您也可以使用既有的還原的虛擬機器 (例如，如果您已在複本伺服器上還原先前的虛擬機器備份，) 為初始複本。 或者，將初始複本複製到外部媒體，然後再將媒體實體送到複本站台，即可節省網路頻寬。  如果您想要使用預先存在的虛擬機器，請刪除所有先前與其相關聯的快照集。

## <a name="deployment-steps"></a>部署步驟

### <a name="step-1-set-up-the-hyper-v-hosts"></a>步驟1：設定 Hyper-v 主機

每一部伺服器上至少需要兩部具有一或多部虛擬機器的 Hyper-v 主機。 [開始使用 hyper-v](../get-started/Get-started-with-Hyper-V-on-Windows.md)。 您將複寫虛擬機器的主機伺服器，必須設定為複本伺服器。

1. 在您要將虛擬機器複寫到的伺服器 Hyper-v 設定中，在 [複寫設定 **] 中選取**[ **啟用此電腦做為複本伺服器**]。

2. 您可以透過 HTTP 或加密的 HTTPS 進行複寫。 選取 [ **使用 Kerberos (HTTP) ** 或 **使用以憑證為基礎的驗證 (HTTPS**) 。 根據預設，HTTP 80 和 HTTPS 443 會在複本 Hyper-v 伺服器上啟用為防火牆例外。 如果您變更預設通訊埠設定，則也必須變更防火牆例外狀況。 如果您是透過 HTTPS 進行複寫，則必須選取憑證，並設定憑證驗證。

3. 針對 [授權]，選取 [ **允許來自任何已驗證服務器** 的複寫]，讓複本伺服器接受來自任何驗證成功之主伺服器的虛擬機器複寫流量。 選取 **[允許從指定的伺服器** 複寫] 只接受來自您明確選取之主伺服器的流量。

    針對這兩個選項，您可以指定複寫 Vhd 儲存在複本 Hyper-v 伺服器上的位置。

4. 按一下 [確定]**** 或 [套用]****。

### <a name="step-2-set-up-the-firewall"></a>步驟2：設定防火牆

若要允許主要和次要伺服器之間的複寫，流量必須透過 Windows 防火牆 (或任何其他協力廠商防火牆) 取得。 當您在伺服器上安裝 Hyper-v 角色時，HTTP (80) 的預設例外狀況，而且會建立 HTTPS (443) 。 如果您使用的是這些標準埠，則只需要啟用規則：

-  若要在獨立主機伺服器上啟用規則：

    1. 開啟 [具有事先安全性的 Windows 防火牆]，然後按一下 [ **輸入規則**]。

    2. 若要啟用 HTTP (Kerberos) 驗證，請以滑鼠右鍵按一下 [ **hyper-v 複本 HTTP 接聽程式 (tcp/ip]，) **  >  **啟用規則**]。 若要啟用以 HTTPS 憑證為基礎的驗證，請以滑鼠右鍵按一下 [ **hyper-v 複本 HTTPS 接聽程式] (tcp-in) **  >  **啟用規則**]。

-  若要在 Hyper-v 叢集上啟用規則，請使用 [以 **系統管理員身分執行**] 來開啟 Windows PowerShell 會話，然後執行下列其中一個命令：

    - 若為 HTTP：  `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTP Listener (TCP-In)"}}`

    - 針對 HTTPS： `get-clusternode | ForEach-Object  {Invoke-command -computername $_.name -scriptblock {Enable-Netfirewallrule -displayname "Hyper-V Replica HTTPS Listener (TCP-In)"}}`

### <a name="enable-virtual-machine-replication"></a>啟用虛擬機器複寫

請在您要複寫的每部虛擬機器上執行下列步驟：

1. 在 [Hyper-v 管理員] 的 **詳細資料** 窗格中，按一下以選取虛擬機器。
    以滑鼠右鍵按一下選取的虛擬機器，然後按一下 [ **啟用** 複寫] 以開啟 [啟用複寫] wizard。

2. 在 [在您開始前]**** 頁面，按 [下一步]****。

3. 在 [ **指定複本伺服器** ] 頁面的 [複本伺服器] 方塊中，輸入複本伺服器的 NETBIOS 或 FQDN。 如果複本伺服器是容錯移轉叢集的一部分，請輸入 Hyper-v 複本代理程式的名稱。 按一下 [下一步]。

4. 在 [ **指定連線參數** ] 頁面上，hyper-v 複本會自動抓取您為複本伺服器設定的驗證和埠設定。 如果未抓取值，請檢查伺服器是否已設定為複本伺服器，並已在 DNS 中註冊。 如果必要，請在設定中手動輸入。

5. 在 [ **選擇複寫 vhd** ] 頁面上，確定已選取您想要複寫的 vhd，並清除要從複寫排除的任何 vhd 的核取方塊。 然後按一下 [下一步]  。

6. 在 [ **設定複寫頻率** ] 頁面上，指定變更應該從主要同步處理到次要複本的頻率。 然後按一下 [下一步]  。

7. 在 [ **設定其他復原點** ] 頁面上，選取您只想要維護最新的復原點，還是要建立額外的點。 如果您想要持續復原具有自己的 VSS 寫入器的應用程式和工作負載，我們建議您選取 **磁碟區陰影複製服務 (VSS) 頻率** ，並指定建立應用程式一致快照的頻率。 請注意，Hyper-v VMM 要求者服務必須同時在主要和次要 Hyper-v 伺服器上執行。 然後按一下 [下一步]  。

8. 在 [ **選擇初始** 複寫] 頁面上，選取要使用的初始複寫方法。  透過網路傳送初始複製的預設設定會將主要虛擬機器組態檔 (>.VMCX) 和虛擬硬碟檔案 (VHDX 和 VHD) 您在網路連線上選取的選項。 如果您要使用此選項，請確認網路頻寬可用性。 如果已將次要網站上的主要虛擬機器設定為複寫虛擬機器，則選取  **[使用複寫伺服器上現有的虛擬機器做為初始複本**] 可能會很有用。 您可以使用 Hyper-v 匯出來匯出主要虛擬機器，並將它匯入為次要伺服器上的複本虛擬機器。 針對較大的虛擬機器或受限的頻寬，您可以選擇在稍後進行網路的初始複寫，然後設定離峰時間，或是以離線媒體的形式傳送初始複寫資訊。

    如果您進行離線複寫，則會使用外部儲存媒體（例如硬碟或 USB 磁片磁碟機），將初始複本傳輸到次要伺服器。 若要這樣做，您必須將外部存放裝置連線到叢集中的主伺服器 (或擁有者節點) 然後當您選取 [使用外部媒體傳送初始副本] 時，可以在本機或在您的外部媒體上指定可儲存初始副本的位置。  複本網站上會建立預留位置虛擬機器。 初始複寫完成之後，就可以將外部儲存體運送到複本網站。 您會將外部媒體連接至次要伺服器或次要叢集的擁有者節點。 然後，您會將初始複本匯入至指定的位置，並將其合併到預留位置虛擬機器中。

9. 在 [ **完成啟用** 複寫] 頁面上，檢查 [摘要] 中的資訊，然後按一下 **[完成]**。 系統會根據您所選擇的設定來傳輸虛擬機器資料。 隨即出現一個對話方塊，指出已成功啟用複寫。

10. 如果您想要設定延伸 (連結) 複寫，請開啟複本伺服器，然後以滑鼠右鍵按一下您要複寫的虛擬機器。 按一下 **[** 複寫  >  **延伸**複寫]，並指定複寫設定。

## <a name="run-a-failover"></a>執行容錯移轉

完成這些部署步驟之後，您的複寫環境就會啟動並執行。 現在您可以視需要執行容錯移轉。

**測試容錯移轉**：如果您想要執行測試容錯移轉 **，請在**主要虛擬機器上按一下滑鼠右鍵，然後選取 [複寫  >  **測試容錯移轉**]。 若已設定，請挑選最新的或其他復原點。 將會在次要網站上建立並啟動新的測試虛擬機器。 測試完成之後，請選取複本虛擬機器上的 [  **停止測試容錯移轉** ]，以進行清理。 請注意，針對虛擬機器，您一次只能執行一次測試容錯移轉。 [閱讀其他資訊](https://docs.microsoft.com/virtualization/community/team-blog/2012/20120725-types-of-failover-operations-in-hyper-v-replica-part-i-test-failover)。

**規劃的容錯移轉**：若要執行規劃的容錯移轉，請以滑鼠右鍵按一下主要虛擬機器，**然後選取 [** 複寫  >  **規劃的容錯移轉**] 規劃的容錯移轉會執行必要條件檢查，以確保零資料遺失。 它會先檢查主要虛擬機器是否已關閉，然後再開始容錯移轉。 虛擬機器容錯移轉之後，就會開始將變更複寫回主要網站（如果有的話）。 請注意，若要這樣做，主伺服器應該設定為在主要叢集的情況下，從次要伺服器或從 Hyper-v 複本代理人接收復寫。 規劃的容錯移轉會傳送最後一組追蹤的變更。 [閱讀其他資訊](https://docs.microsoft.com/virtualization/community/team-blog/2012/20120731-types-of-failover-operations-in-hyper-v-replica-part-ii-planned-failover)。

未**計畫的容錯移轉**：若要執行未規劃的容錯移轉，請在複本虛擬機器上按一下滑鼠右鍵，然後**Replication**  >  從 hyper-v 管理員或容錯移轉叢集管理員選取 [複寫未規劃的**容錯移轉**]。 如果啟用此選項，您可以從最新的復原點或從先前的復原點復原。 容錯移轉之後，請檢查容錯移轉虛擬機器上的一切是否如預期般運作，然後按一下複本虛擬機器上的 [ **完成** ]。 [閱讀其他資訊](https://docs.microsoft.com/virtualization/community/team-blog/2012/20120808-types-of-failover-operations-in-hyper-v-replica-part-iii-unplanned-failover)。
