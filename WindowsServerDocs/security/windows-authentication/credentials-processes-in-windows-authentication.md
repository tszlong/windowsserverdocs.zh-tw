---
title: Windows 驗證中的認證程序
description: 瞭解 Windows 驗證如何處理認證。
ms.topic: article
ms.assetid: 48c60816-fb8b-447c-9c8e-800c2e05b14f
ms.author: lizross
author: eross-msft
manager: mtillman
ms.date: 10/12/2016
ms.openlocfilehash: 397294b9dba9535b098dde715e8eef75ae50cad5
ms.sourcegitcommit: decb6c8caf4851b13af271d926c650d010a6b9e9
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 01/13/2021
ms.locfileid: "98177597"
---
# <a name="credentials-processes-in-windows-authentication"></a>Windows 驗證中的認證程序

>適用於：Windows Server (半年度管道)、Windows Server 2016

IT 專業人員的本參考主題描述 Windows 驗證如何處理認證。

Windows 認證管理是指作業系統從服務或使用者接收認證的程式，並將該資訊保護于未來呈現給驗證目標。 如果是已加入網域的電腦，驗證目標就是網域控制站。 驗證中使用的認證是數位檔，可將使用者的身分識別與某種形式的真實性，例如憑證、密碼或 PIN。

根據預設，系統會針對本機電腦上的安全性帳戶管理員 (SAM) 資料庫，或針對已加入網域之電腦上的 Active Directory，使用 Winlogon 服務來驗證 Windows 認證。 認證是透過登入使用者介面上的使用者輸入，或透過應用程式開發介面以程式設計方式進行收集， (API) 提供給驗證目標。

本機安全性資訊會儲存在 **HKEY_LOCAL_MACHINE\SECURITY** 的登錄中。 儲存的資訊包括原則設定、預設安全性值，以及帳戶資訊，例如快取的登入認證。 SAM 資料庫的複本也會儲存在這裡，雖然它會受到寫入保護。

下圖顯示所需的元件，以及認證透過系統進行驗證以驗證使用者或處理成功登入的路徑。

![顯示必要元件的圖表，以及認證透過系統進行驗證以驗證使用者或處理成功登入的路徑。](../media/credentials-processes-in-windows-authentication/AuthN_LSA_Architecture_Client.gif)

下表說明每個元件在登入時管理驗證程式中的認證。

**所有系統的驗證元件**

|元件|描述|
|-------|--------|
|使用者登入|Winlogon.exe 是負責管理安全使用者互動的可執行檔。 Winlogon 服務會初始化 Windows 作業系統的登入程式，方法是將使用者動作在安全桌面電腦上所收集的認證傳遞 (登入 UI，) 到本地安全機構 (LSA) 到 Secur32.dll。|
|應用程式登入|不需要互動式登入的應用程式或服務登入。 使用者所起始的大部分進程會使用 Secur32.dll 在使用者模式中執行，而在啟動時起始的進程（例如服務）則是使用 Ksecdd.sys 在核心模式中執行。<p>如需使用者模式和核心模式的詳細資訊，請參閱本主題中的應用程式和使用者模式或服務和核心模式。|
|Secur32.dll|構成驗證程式基礎的多個驗證提供者。|
|Lsasrv.dll|LSA 伺服器服務，這兩項服務都會強制執行安全性原則，並作為 LSA 的安全性套件管理員。 LSA 包含 Negotiate 函式，它會在判斷哪一種通訊協定成功之後，選取 NTLM 或 Kerberos 通訊協定。|
|安全性支援提供者|一組可個別叫用一或多個驗證通訊協定的提供者。 每個 Windows 作業系統版本都可以變更一組預設的提供者，而且可以撰寫自訂提供者。|
|Netlogon.dll|Net Logon 服務所執行的服務如下：<p>-維護電腦的安全通道 (不會與網域控制站的 Schannel) 混淆。<br />-透過安全通道將使用者的認證傳遞至網域控制站，並傳回 (Sid) 的網域安全識別碼和使用者的使用者權限。<br />-在網域名稱系統中將服務資源記錄發佈 (DNS) ，並使用 DNS 將名稱解析為網際網路通訊協定 (IP) 位址的網域控制站。<br />-根據遠端程序呼叫來執行複寫通訊協定， (RPC) 來同步處理網域主控站 (Pdc) 和備份網域控制站 (Bdc) 。|
|Samsrv.dll|安全性帳戶管理員 (SAM) ，它會儲存本機安全性帳戶、強制執行本機儲存的原則，並支援 Api。|
|登錄|登錄包含 SAM 資料庫、本機安全性原則設定、預設安全性值，以及只有系統可以存取的帳戶資訊的複本。|

本主題包含下列幾節：

-   [使用者登入的認證輸入](#BKMK_CrentialInputForUserLogon)

-   [應用程式和服務登入的認證輸入](#BKMK_CredentialInputForApplicationAndServiceLogon)

-   [本機安全性授權](#BKMK_LSA)

-   [快取的認證和驗證](#BKMK_CachedCredentialsAndValidation)

-   [認證儲存和驗證](#BKMK_CredentialStorageAndValidation)

-   [安全性帳戶管理員資料庫](#BKMK_SAM)

-   [本機網域和信任的網域](#BKMK_LocalDomainsAndTrustedDomains)

-   [Windows 驗證中的憑證](#BKMK_CertificatesInWindowsAuthentication)

## <a name="credential-input-for-user-logon"></a><a name="BKMK_CrentialInputForUserLogon"></a>使用者登入的認證輸入
在 Windows Server 2008 和 Windows Vista 中，以認證提供者模型取代 (GINA) 架構的圖形識別與驗證，讓您可以透過使用登入磚來列舉不同的登入類型。 這兩種模型如下所述。

**圖形識別與驗證架構**

圖形識別與驗證 (GINA) 架構適用于 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 及 Windows 2000 Professional 作業系統。 在這些系統中，每個互動式登入會話都會建立不同的 Winlogon 服務實例。 GINA 架構會載入至 Winlogon 所使用的進程空間、接收和處理認證，以及透過 LSALogonUser 對驗證介面進行呼叫。

在會話0中互動式登入執行的 Winlogon 實例。 會話0裝載系統服務和其他重要進程，包括本地安全機構 (LSA) 進程。

下圖顯示 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Microsoft Windows 2000 Professional 的認證程式。

![此圖顯示 Windows Server 2003、Microsoft Windows 2000 Server、Windows XP 和 Microsoft Windows 2000 Professional 的認證程式](../media/credentials-processes-in-windows-authentication/AuthN_GINA_Architecture.gif)

**認證提供者架構**

認證提供者架構適用于本主題開頭的 **適用** 物件清單中指定的版本。 在這些系統中，認證輸入架構會使用認證提供者變更為可擴充的設計。 這些提供者是由安全桌面上的不同登入磚所代表，可允許任何數目的登入案例-相同使用者的不同帳戶，以及不同的驗證方法，例如密碼、智慧卡和生物識別。

使用認證提供者架構時，Winlogon 一律會在收到安全的注意順序事件之後啟動登入 UI。 登入 UI 會針對提供者設定為要列舉的不同認證類型數目，查詢每個認證提供者。 認證提供者可以選擇指定其中一個圖格作為預設值。 當所有提供者都列舉其磚之後，登入 UI 就會向使用者顯示。 使用者會與磚互動以提供其認證。 登入 UI 會提交這些認證以進行驗證。

認證提供者不是強制性機制。 它們是用來收集和序列化認證。 本地安全機構和驗證套件會強制執行安全性。

認證提供者會在電腦上註冊，並負責下列各項：

-   描述驗證所需的認證資訊。

-   使用外部驗證授權單位處理通訊和邏輯。

-   封裝互動式和網路登入的認證。

封裝互動式和網路登入的認證包含序列化程式。 藉由將認證序列化，可以在登入 UI 上顯示多個登入磚。 因此，您的組織可以透過使用自訂的認證提供者，來控制登入顯示，例如使用者、登入的目標系統、網路的登錄前存取、工作站鎖定/解除鎖定原則。 同一部電腦上可以並存多個認證提供者。

單一登入 (SSO) 提供者可以作為標準認證提供者或預先登入存取提供者來開發。

每個版本的 Windows 都包含一個預設的認證提供者，以及一個預設的預先登入存取提供者 (PLAP) ，也稱為 SSO 提供者。 SSO 提供者允許使用者在登入本機電腦之前，建立與網路的連線。 當這個提供者執行時，提供者不會列舉登入 UI 上的磚。

SSO 提供者的用途是要用於下列案例：

-   **網路驗證和電腦登入是由不同的認證提供者處理。** 此案例的變化包括：

    -   使用者可以選擇連線到網路，例如在登入電腦之前 (VPN) 連線到虛擬私人網路，但不需要進行此連接。

    -   需要網路驗證才能抓取在本機電腦上進行互動式驗證時所使用的資訊。

    -   多個網路驗證接著是其他案例的其中一個。 例如，使用者會向網際網路服務提供者 (ISP) 進行驗證、向 VPN 進行驗證，然後使用他們的使用者帳號憑證來登入本機。

    -   快取的認證已停用，而且需要透過 VPN 進行遠端存取服務連線，才能驗證使用者。

    -   網域使用者沒有在已加入網域的電腦上設定本機帳戶，而且必須透過 VPN 連線建立遠端存取服務連線，才能完成互動式登入。

-   **網路驗證和電腦登入都是由相同的認證提供者來處理。** 在此案例中，使用者必須先連接到網路，才能登入電腦。

**登入磚列舉**

認證提供者會列舉下列實例中的登入磚：

-   適用于本主題開頭的 **適用** 物件清單中所指定的作業系統。

-   認證提供者會列舉工作站登入的磚。 認證提供者通常會將驗證的認證序列化為本地安全機構。 此程式會顯示每個使用者的特定圖格，以及每位使用者的目標系統特定的磚。

-   登入和驗證架構可讓使用者使用認證提供者所列舉的磚來解除工作站的鎖定。 一般而言，目前登入的使用者是預設磚，但如果有多個使用者登入，則會顯示許多磚。

-   認證提供者會列舉磚，以回應使用者要求變更其密碼或其他私用資訊（例如 PIN）。 一般而言，目前登入的使用者是預設磚;但是，如果有多個使用者登入，則會顯示多個磚。

-   認證提供者會根據要在遠端電腦上用來進行驗證的序列化認證來列舉磚。 認證 UI 不會使用提供者的相同實例作為登入 UI、解除鎖定工作站或變更密碼。 因此，無法在認證 UI 實例之間的提供者中維護狀態資訊。 此結構會針對每一部遠端電腦登入產生一個磚，假設認證已正確序列化。 此案例也會用於 (UAC) 的使用者帳戶控制，藉由提示使用者提供許可權或系統管理員密碼，以在允許可能影響電腦的操作或可能變更影響電腦其他使用者的設定之前，先提示使用者提供許可權或系統管理員密碼，以協助防止未經授權的電腦變更。

下圖顯示本主題開頭的 [ **適用于** ] 清單中所指定之作業系統的認證處理常式。

![此圖顯示在本主題開頭的 * * [適用于] 清單中所指定之作業系統的認證程式](../media/credentials-processes-in-windows-authentication/AuthN_CredMan_CredProv.gif)

## <a name="credential-input-for-application-and-service-logon"></a><a name="BKMK_CredentialInputForApplicationAndServiceLogon"></a>應用程式和服務登入的認證輸入
Windows 驗證的設計目的是為了管理不需要使用者互動的應用程式或服務的認證。 使用者模式中的應用程式在其可存取的系統資源方面受到限制，而服務可以不受限制地存取系統記憶體和外部裝置。

系統服務和傳輸層級應用程式會透過 Windows 中的安全性支援提供者介面（ (SSPI) 的安全性支援提供者介面）來存取安全性支援提供者 (SSP) ，其提供用來列舉系統上可用之安全性封裝的函式、選取封裝，以及使用該套件來取得已驗證的連接。

當用戶端/伺服器連接通過驗證時：

-   用戶端上的應用程式會使用 SSPI 函數將認證傳送至伺服器 `InitializeSecurityContext (General)` 。

-   連接之伺服器端上的應用程式會回應 SSPI 函數 `AcceptSecurityContext (General)` 。

-   SSPI 函式 `InitializeSecurityContext (General)` 和 `AcceptSecurityContext (General)` 會重複，直到所有必要的驗證訊息都已交換為成功或驗證失敗為止。

-   連接經過驗證之後，伺服器上的 LSA 會使用來自用戶端的資訊來建立包含存取權杖的安全性內容。

-   伺服器接著可以呼叫 SSPI 函 `ImpersonateSecurityContext` 式，將存取權杖附加至服務的模擬執行緒。

**應用程式和使用者模式**

Windows 中的使用者模式是由兩個能夠將 i/o 要求傳遞至適當核心模式驅動程式的系統所組成：環境系統，它會執行針對許多不同類型的作業系統所撰寫的應用程式，以及代表環境系統運作系統專屬函式的整數系統。

整數系統會代表環境系統管理操作 system'specific 函式，並包含 (LSA) 、工作站服務和伺服器服務的安全性系統進程。 安全性系統進程會處理安全性權杖、授與或拒絕許可權，以根據資源許可權存取使用者帳戶、處理登入要求和起始登入驗證，以及判斷作業系統需要進行哪些系統資源的審核。

應用程式可以在使用者模式下執行，應用程式可以在其中以任何主體的形式執行，包括本機系統 (系統) 的安全性內容。 應用程式也可以在核心模式下執行，應用程式可以在本機系統 (系統) 的安全性內容中執行。

SSPI 可透過 Secur32.dll 模組取得，這是用來取得整合式安全性服務以進行驗證、訊息完整性和訊息隱私權的 API。 它會在應用層級通訊協定和安全性通訊協定之間提供抽象層。 因為不同的應用程式需要不同的方式來識別或驗證使用者，以及在網路上傳送資料時加密資料的不同方式，所以 SSPI 會提供一種方式來存取動態連結程式庫 (Dll) ，其中包含不同的驗證和密碼編譯功能。 這些 Dll 稱為 (Ssp) 的安全性支援提供者。

受管理的服務帳戶和虛擬帳戶是在 Windows Server 2008 R2 和 Windows 7 中引進的，可提供重要的應用程式（例如 Microsoft SQL Server 和 Internet Information Services (IIS) ），並隔離自己的網域帳戶，同時不需要系統管理員手動管理服務主體名稱 (SPN) 和這些帳戶的認證。 如需這些功能及其在驗證中角色的詳細資訊，請參閱 [Windows 7 和 Windows Server 2008 R2 的受控服務帳戶檔](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff641731(v=ws.10)) 和 [群組受管理的服務帳戶總覽](../group-managed-service-accounts/group-managed-service-accounts-overview.md)。

**服務和核心模式**

雖然大部分的 Windows 應用程式都是在啟動這些應用程式之使用者的安全性內容中執行，但是這並不是服務的真正問題。 許多 Windows 服務（例如網路和列印服務）都是由服務控制器在使用者啟動電腦時啟動。 這些服務可能會以本機服務或本機系統的形式執行，而且可能會在最後一個使用者登出之後繼續執行。

> [!NOTE]
> 服務通常會在稱為「本機系統」 (系統) 、「網路服務」或「本機服務」的安全性內容中執行。  Windows Server 2008 R2 引進的服務是在受管理的服務帳戶下執行，也就是網域主體。

在啟動服務之前，服務控制器會使用針對服務所指定的帳號來登入，然後提供由 LSA 進行驗證的服務認證。 Windows 服務會執行服務控制器管理員可用來控制服務的程式設計介面。 當系統啟動或以手動方式使用服務控制程式時，可以自動啟動 Windows 服務。 例如，當 Windows 用戶端電腦加入網域時，電腦上的 messenger 服務會連接到網域控制站，並為其開啟安全通道。 若要取得已驗證的連線，服務必須擁有遠端電腦的本機安全機構 (LSA) 信任的認證。 當與網路中的其他電腦進行通訊時，LSA 會使用本機電腦網域帳戶的認證，就像在本機系統和網路服務的安全性內容中執行的所有其他服務一樣。 本機電腦上的服務會以系統身分執行，因此不需要向 LSA 呈現認證。

此檔案 Ksecdd.sys 管理和加密這些認證，並使用 LSA 的本機程序呼叫。 檔案類型是 WINSPOOL.DRV (驅動程式) ，也稱為核心模式安全性支援提供者 (SSP) ，在本主題開頭的 **適用** 物件清單中指定的版本中，則是符合 FIPS 140-2 層級1規範。

核心模式具有電腦的硬體和系統資源的完整存取權。 核心模式會停止使用者模式服務和應用程式，使其無法存取不應存取之作業系統的重要區域。

## <a name="local-security-authority"></a><a name="BKMK_LSA"></a>本機安全性授權
 (LSA) 的「本地安全機構」是受保護的系統進程，可驗證使用者並將其登入本機電腦。 此外，LSA 會維護電腦上本機安全性的所有層面的相關資訊 (這些層面統稱為本機安全性原則) ，而且會提供各種服務，以在名稱和安全性識別碼 (Sid) 之間進行轉譯。 安全性系統進程（本地安全性授權單位伺服器服務 (LSASS) ）會追蹤安全性原則以及電腦系統上的作用中帳戶。

LSA 會根據下列兩個實體發出使用者的帳戶來驗證使用者的身分識別：

-   **本地安全機構。** LSA 可以檢查安全性帳戶管理員 (SAM) 資料庫位於同一部電腦上，藉以驗證使用者資訊。 任何工作站或成員伺服器都可以儲存本機使用者帳戶和本機群組的相關資訊。 不過，這些帳戶只能用來存取工作站或電腦。

-   **本機網域或受信任網域的安全性授權單位。** LSA 會與發出帳戶的實體聯繫，並要求帳戶有效且要求是來自帳戶持有者的驗證。

本機安全性授權子系統服務 (LSASS) 會代表使用中 Windows 工作階段的使用者，將認證儲存在記憶體中。 儲存的認證可讓使用者順暢地存取網路資源，例如檔案共用、Exchange Server 信箱和 SharePoint 網站，而不需要為每個遠端服務重新輸入其認證。

LSASS 可以使用多種形式儲存認證，包括：

-   可回復的已加密純文字

-   Kerberos 票證 (票證授權票證 (Tgt) 、服務票證) 

-   NT 雜湊

-   LAN Manager (LM) 雜湊

如果使用者使用智慧卡登入 Windows，LSASS 不會儲存純文字密碼，但會儲存該帳戶的對應 NT 雜湊值和智慧卡的純文字 PIN。 如果為互動式登入所需的智慧卡啟用帳戶屬性，則會為帳戶自動產生隨機 NT 雜湊值，而不是原始的密碼雜湊。 設定屬性時自動產生的密碼雜湊不會變更。

如果使用者以與 LAN Manager 相容的密碼登入 Windows 電腦 (LM) 雜湊，則此驗證器會出現在記憶體中。

您不能停用在記憶體中純文字認證的儲存體，即使需要它們的認證提供者已被停用。

預存認證會直接與最後一次重新開機後已啟動且尚未關閉的本機安全性授權子系統服務 (LSASS) 登入會話相關聯。 例如，當使用者執行下列其中一項動作時，會建立具有儲存的 LSA 認證的 LSA 工作階段：

-   登入本機會話或遠端桌面通訊協定電腦上 (RDP) 會話

-   使用 [RunAs] 選項執行工作

-   在電腦上執行使用中的 Windows 服務

-   執行排程的工作或批次工作

-   使用遠端系統管理工具在本機電腦上執行工作

在某些情況下，LSA 秘密，也就是只有系統帳戶處理常式才能存取的秘密資料片段，會儲存在硬碟上。 部分這些密碼是重新開機後必須保留的認證，它們是以加密形式儲存在硬碟上。 儲存為 LSA 密碼的認證可能包括：

-   電腦的 Active Directory Domain Services (AD DS) 帳戶的帳戶密碼

-   電腦上設定的 Windows 服務的帳戶密碼

-   已設定排程工作的帳戶密碼

-   IIS 應用程式集區及網站的帳戶密碼

-   Microsoft 帳戶的密碼

在 Windows 8.1 引進的用戶端作業系統為 LSA 提供額外的保護，以防止未受保護的進程讀取記憶體和插入程式碼。 這種保護可提高 LSA 儲存和管理之認證的安全性。

如需這些額外保護的詳細資訊，請參閱設定 [額外的 LSA 保護](../credentials-protection-and-management/configuring-additional-lsa-protection.md)。

## <a name="cached-credentials-and-validation"></a><a name="BKMK_CachedCredentialsAndValidation"></a>快取的認證和驗證
驗證機制會在登入時依賴認證的呈現方式。 不過，當電腦與網域控制站中斷連線，而且使用者正在呈現網域認證時，Windows 會在驗證機制中使用快取認證的程式。

每次使用者登入網域時，Windows 就會快取所提供的認證，並將其儲存在作業系統登錄的安全性 hive 中。

使用快取認證時，使用者可以登入網域成員，而不需要連線到該網域內的網域控制站。


## <a name="credential-storage-and-validation"></a><a name="BKMK_CredentialStorageAndValidation"></a>認證儲存和驗證
您不一定要使用一組認證來存取不同的資源。 例如，在存取遠端伺服器時，系統管理員可能會想要使用系統管理而非使用者認證。 同樣地，如果使用者存取外部資源（例如銀行帳戶），則只能使用與其網域認證不同的認證。 下列各節說明目前版本的 Windows 作業系統和 Windows Vista 和 Windows XP 作業系統之間的認證管理差異。

### <a name="remote-logon-credential-processes"></a>遠端登入認證處理常式
遠端桌面通訊協定 (RDP) 會使用 Windows 8 引進的遠端桌面用戶端，來管理連線到遠端電腦之使用者的認證。 純文字格式的認證會傳送至主機嘗試執行驗證程式的目標主機，如果成功，則會將使用者連接到允許的資源。 RDP 不會將認證儲存在用戶端，但使用者的網域認證會儲存在 LSASS 中。

受限制的系統管理模式在 Windows Server 2012 R2 和 Windows 8.1 中引進，可提供遠端登入案例的額外安全性。 這種遠端桌面模式會導致用戶端應用程式使用 NT 單向函式 (NTOWF) 來執行網路登入挑戰-回應，或在向遠端主機進行驗證時使用 Kerberos 服務票證。 系統管理員經過驗證之後，就不會在 LSASS 中有各自的帳號憑證，因為它們不會提供給遠端主機。 相反地，系統管理員有會話的電腦帳號憑證。 系統管理員認證不會提供給遠端主機，因此會以電腦帳戶的身分執行動作。 資源也會限制為電腦帳戶，而系統管理員無法使用自己的帳戶來存取資源。

### <a name="automatic-restart-sign-on-credential-process"></a>自動重新開機登入認證程式
當使用者登入 Windows 8.1 裝置時，LSA 會將使用者認證儲存在加密的記憶體中，而且只有 LSASS.exe 才能存取。 當 Windows Update 在沒有使用者的情況下起始自動重新開機時，就會使用這些認證來設定使用者的自動登入。

重新開機時，使用者會透過自動登入機制自動登入，然後再鎖定電腦以保護使用者的會話。 鎖定是透過 Winlogon 起始，而認證管理是由 LSA 進行。 藉由在主控台上自動登入和鎖定使用者的會話，使用者的鎖定畫面應用程式會重新開機並可供使用。

如需 ARSO 的詳細資訊，請參閱 [Winlogon 自動重新開機 Sign-On &#40;ARSO&#41;](winlogon-automatic-restart-sign-on-arso.md)。

### <a name="stored-user-names-and-passwords-in-windows-vista-and-windows-xp"></a>Windows Vista 和 Windows XP 中的預存使用者名稱和密碼
在 Windows Server 2008、Windows Server 2003、Windows Vista 和 Windows XP 中，主控台中 **儲存的使用者名稱和密碼** 可簡化多組登入認證的管理和使用，包括與智慧卡和 Windows Live 認證搭配使用的 x.509 憑證 (現在稱為 Microsoft 帳戶) 。 認證（使用者設定檔的一部分）會儲存到需要的部分。 這個動作可以藉由確保某個密碼遭到入侵，而不會危及所有安全性，以每個資源為基礎來提高安全性。

當使用者登入並嘗試存取其他受密碼保護的資源（例如伺服器上的共用），而且使用者的預設登入認證不足以取得存取權時，就會查詢 **儲存的使用者名稱和密碼** 。 如果以正確登入資訊儲存的替代認證已儲存在已 **儲存的使用者名稱和密碼** 中，則會使用這些認證來取得存取權。 否則，系統會提示使用者提供新的認證，然後在登入會話中或後續會話期間，將其儲存以供重複使用。

適用以下限制：

-   如果 **儲存的使用者名稱和密碼** 包含特定資源的無效或不正確的認證，則會拒絕存取資源，且不會顯示 [ **儲存的使用者名稱和密碼** ] 對話方塊。

-   **儲存的使用者名稱和密碼** 只會儲存 NTLM、Kerberos 通訊協定、Microsoft 帳戶 (先前的 WINDOWS Live ID) ，以及安全通訊端層 (SSL) 驗證的認證。 某些版本的 Internet Explorer 會維護自己的快取以進行基本驗證。

這些認證會在 \Documents 和 Settings\Username\Application Data\Microsoft\Credentials 目錄中成為使用者本機設定檔的加密部分。 如此一來，如果使用者的網路原則支援漫遊使用者設定檔，這些認證就可以與使用者漫遊。 不過，如果使用者在兩部不同的電腦上有已 **儲存的使用者名稱和密碼** 的複本，並變更與其中一部電腦上的資源相關聯的認證，則變更不會傳播到第二部電腦上的 **儲存使用者名稱和密碼** 。

### <a name="windows-vault-and-credential-manager"></a>Windows 保存庫和認證管理員
認證管理員在 Windows Server 2008 R2 和 Windows 7 中引進，做為儲存和管理使用者名稱和密碼的主控台功能。 認證管理員可讓使用者在安全的 Windows 保存庫中儲存與其他系統和網站相關的認證。 某些版本的 Internet Explorer 會使用這項功能來驗證網站。

使用認證管理員的認證管理是由本機電腦上的使用者所控制的。 使用者可以儲存和存放支援的瀏覽器及 Windows 應用程式的認證，便於在需要登入這些資源時使用。 認證會儲存在電腦上以使用者設定檔為依據的特殊加密資料夾。 支援此功能的應用程式 (透過使用認證管理員 Api) （例如網頁瀏覽器和應用程式），可以在登入程式期間，向其他電腦和網站出示正確的認證。

當網站、應用程式或另一部電腦透過 NTLM 或 Kerberos 通訊協定要求驗證時，會出現一個對話方塊，您可以在其中選取 [ **更新預設認證** ] 或 [ **儲存密碼** ] 核取方塊。 此對話方塊可讓使用者在本機上儲存認證，是由支援認證管理員 Api 的應用程式所產生。 如果使用者選取 [ **儲存密碼** ] 核取方塊，認證管理員會持續追蹤使用者的使用者名稱、密碼，以及使用中驗證服務的相關資訊。

下次使用服務時，認證管理員會自動提供儲存在 Windows 保存庫中的認證。 如果不接受這個認證，則會提示使用者輸入正確的存取資訊。 如果使用新的認證來授與存取權，認證管理員會以新的認證覆寫先前的認證，然後將新的認證儲存在 Windows 保存庫中。

## <a name="security-accounts-manager-database"></a><a name="BKMK_SAM"></a>安全性帳戶管理員資料庫
安全性帳戶管理員 (SAM) 是儲存本機使用者帳戶和群組的資料庫。 它存在於每個 Windows 作業系統;但是，當電腦加入網域時，Active Directory 會管理 Active Directory 網域中的網域帳戶。

例如，執行 Windows 作業系統的用戶端電腦會透過與網域控制站通訊來參與網路網域，即使沒有任何人為登入也一樣。 若要起始通訊，電腦必須具有網域中的使用中帳戶。 在接受來自電腦的通訊之前，網域控制站上的 LSA 會驗證電腦的身分識別，然後以與人類安全性主體相同的方式來建立電腦的安全性內容。 此安全性內容會定義特定電腦或網路上的使用者、服務或電腦上的使用者或服務的身分識別和功能。 例如，安全性內容中包含的存取權杖會定義資源 (例如，可存取的檔案共用或印表機) ，以及可由該主體執行的動作 (例如讀取、寫入或修改) 、該資源上的使用者、電腦或服務。

使用者或電腦的安全性內容可能會因電腦而異，例如，當使用者登入的伺服器或工作站不是使用者自己的主要工作站時。 它也可能因某個會話而異，例如當系統管理員修改使用者的權利和許可權時。 此外，當使用者或電腦以獨立方式、網路或 Active Directory 網域的一部分運作時，安全性內容通常會有所不同。

## <a name="local-domains-and-trusted-domains"></a><a name="BKMK_LocalDomainsAndTrustedDomains"></a>本機網域和信任的網域
當兩個網域之間存在信任時，每個網域的驗證機制都會依賴來自另一個網域之驗證的有效性。 信任可協助您藉由確認連入驗證要求來自信任的網域)  (信任的授權單位，來提供資源網域中共用資源的控制存取權， (信任網域) 。 如此一來，信任就會扮演橋接器，讓只有經過驗證的驗證要求在網域之間移動。

特定信任通過驗證要求的方式取決於其設定方式。 信任關係可以是單向的，方法是提供從受信任網域到信任網域中資源的存取權，或雙向，方法是提供從每個網域存取另一個網域中的資源。 信任也是不可轉移的，在這種情況下，信任只存在於兩個信任夥伴網域之間，或可轉移，在這種情況下，信任會自動延伸至任何夥伴信任的其他網域。

如需有關驗證的網域和樹系信任關係的詳細資訊，請參閱 [委派的驗證和信任關係](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dn169022(v=ws.10))。

## <a name="certificates-in-windows-authentication"></a><a name="BKMK_CertificatesInWindowsAuthentication"></a>Windows 驗證中的憑證
 (PKI) 的公開金鑰基礎結構是軟體、加密技術、程式和服務的組合，可讓組織保護其通訊和商務交易。 PKI 保護通訊和商務交易的能力，取決於已驗證使用者與受信任資源之間的數位憑證交換。

數位憑證是一種電子檔，其中包含所屬實體的相關資訊、簽發的實體、唯一的序號或其他唯一的識別碼、發行和到期日，以及數位指紋。

驗證是判斷遠端主機是否可以受信任的程式。 若要建立其可信度，遠端主機必須提供可接受的驗證憑證。

遠端主機會藉由取得憑證授權單位單位 (CA) 的憑證來建立其可信度。 接著，CA 可以從較高的授權單位取得認證，以建立信任鏈。 若要判斷憑證是否值得信任，應用程式必須判斷根 CA 的身分識別，然後判斷它是否值得信任。

同樣地，遠端主機或本機電腦必須判斷使用者或應用程式所呈現的憑證是否為真。 使用者透過 LSA 和 SSPI 提供的憑證，會在本機電腦上的本機登錄、網路上或透過 Active Directory 的憑證存放區來評估本機電腦上的真實性。

為了產生憑證，驗證資料會通過雜湊演算法（例如安全雜湊演算法 1 (SHA1) ）來產生訊息摘要。 接著會使用寄件者的私密金鑰，以數位方式簽署訊息摘要，以證明訊息摘要是由傳送者所產生。

> [!NOTE]
> SHA1 是 Windows 7 和 Windows Vista 中的預設值，但已變更為 Windows 8 中的 SHA2。

**智慧卡驗證**

智慧卡技術是以憑證為基礎的驗證範例。 使用智慧卡登入網路可提供強式驗證形式，因為它會在向網域驗證使用者時，使用以密碼編譯為基礎的識別和擁有權證明。 Active Directory 憑證服務 (AD CS) 透過發行每個智慧卡的登入憑證來提供密碼編譯式識別。

如需智慧卡驗證的相關資訊，請參閱 [Windows 智慧卡技術參考](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/ff404297(v=ws.10))。

虛擬智慧卡技術是在 Windows 8 引進。 它會將智慧卡的憑證儲存在電腦中，然後使用裝置的防篡改可信賴平臺模組 (TPM) 安全性晶片來保護它。 如此一來，電腦就會真正成為智慧卡，必須接收使用者的 PIN 才能進行驗證。

**遠端和無線驗證**

遠端和無線網路驗證是另一種使用憑證進行驗證的技術。 網際網路驗證服務 (IAS) 和虛擬私人網路伺服器使用可延伸的驗證 Protocol-Transport 層級安全性 (EAP-TLS) 、受保護的可延伸驗證通訊協定 (PEAP) ，或網際網路通訊協定安全性 (IPsec) ，以針對許多網路存取類型執行憑證型驗證，包括虛擬私人網路 (VPN) 和無線連接。

如需網路中以憑證為基礎的驗證相關資訊，請參閱 [網路存取驗證和憑證](/previous-versions/windows/it-pro/windows-server-2003/cc759575(v=ws.10))。

## <a name="see-also"></a><a name="BKMK_SeeAlso"></a>另請參閱
[Windows 驗證概念](./windows-authentication-concepts.md)