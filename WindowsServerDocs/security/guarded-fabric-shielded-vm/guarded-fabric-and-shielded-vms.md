---
description: 深入瞭解：受防護網狀架構與受防護的 Vm 總覽
title: 受防護網狀架構與受防護的 VM 概觀
ms.topic: article
manager: dongill
author: rpsqrd
ms.author: ryanpu
ms.date: 08/29/2018
ms.openlocfilehash: f80daef1d7d6bfae0cc78e3ed41474995186fbb5
ms.sourcegitcommit: 65b6de6b44d41f1180c45db11cdd60cb2a093b46
ms.translationtype: MT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/10/2020
ms.locfileid: "97047526"
---
# <a name="guarded-fabric-and-shielded-vms-overview"></a>受防護網狀架構與受防護的 VM 概觀

>適用于： Windows Server 2019、Windows Server (半年通道) 、Windows Server 2016

## <a name="overview-of-the-guarded-fabric"></a>受防護網狀架構概觀

虛擬化安全性是 Hyper-v 的主要投資領域。 除了保護主機或其他虛擬機器不受執行惡意軟體的虛擬機器影響之外，我們也需要保護虛擬機器不會因為主機遭到入侵而受到危害。 這是現今每個虛擬化平臺的基本風險，無論是 Hyper-v、VMware 或任何其他虛擬化平臺。 道理很簡單，如果虛擬機器離開組織 (無論是惡意或意外)，該虛擬機器就可在任何其他系統上執行。 保護您組織中的高價值資產 (例如網域控制站、敏感性檔案伺服器及 HR 系統) 是第一優先考量。

為了協助防範遭入侵的虛擬化網狀架構，Windows Server 2016 Hyper-v 引進了受防護的 Vm。 受防護的 VM 是第2代 VM (在具有虛擬 TPM 的 Windows Server 2012 和更新版本) 上支援，並使用 BitLocker 進行加密，而且只能在網狀架構中狀況良好且已核准的主機上執行。 受防護的 VM 和受防護網狀架構可讓雲端服務提供者或企業私人雲端系統管理員為租用戶 VM 提供更安全的環境。

受防護網狀架構包含：

- 1 項主機守護者服務 (HGS) (通常是有 3 個節點的叢集)
- 1 或多部受防護主機
- 一組受防護的虛擬機器。 以下圖表說明「主機守護者服務」如何使用證明以確保只有已知且有效的主機可以啟動受防護的 VM，以及如何使用金鑰保護來安全地發行受防護的 VM 的金鑰。

當租用戶建立在受防護網狀架構上執行的受防護的 VM 時，Hyper-V 主機和受防護的 VM 本身會由 HGS 保護。 HGS 提供兩種不同的服務：證明和金鑰保護。 「證明」服務可確保僅有受信任的 Hyper-V 主機可以執行受防護的 VM，而「金鑰保護」服務可提供將它們開機，並即時移轉到其他受防護主機時所需的金鑰。

![受防護主機網狀架構](../media/Guarded-Fabric-Shielded-VM/Guarded-Host-Overview-Diagram.png)

## <a name="video-introduction-to-shielded-virtual-machines"></a>影片：受防護虛擬機器的簡介

> [!VIDEO https://channel9.msdn.com/Shows/Mechanics/Introduction-to-Shielded-Virtual-Machines-in-Windows-Server-2016/player]

## <a name="attestation-modes-in-the-guarded-fabric-solution"></a>受防護網狀架構解決方案中的證明模式

HGS 針對受防護網狀架構支援不同的證明模式：

- TPM-信任的證明 (以硬體為基礎的) 
- 根據非對稱金鑰組的主機金鑰證明 () 

建議使用 TPM 信任證明，因為它提供更強的保證 (如下表中所述)，但它要求您的 Hyper-V 主機要有 TPM 2.0。 如果您目前沒有 TPM 2.0 或任何 TPM，則可以使用主機金鑰證明。 如果您決定在取得新硬體時移動 TPM 信任證明，您可以在「主機守護者服務」上切換證明模式，而且這幾乎不會中斷您的網狀架構。

| **您選擇的主機證明模式** | **主機保證** |
|--|--|
| **TPM 信任證明：** 提供可能的最強保護，但也要求更多的設定步驟。 主機硬體和固件必須包含已啟用安全開機的 TPM 2.0 和 UEFI 2.3.1。 | 受防護的主機會根據其 TPM 身分識別、測量開機順序和程式碼完整性原則進行核准，以確保它們只會執行核准的程式碼。 |
| **主機金鑰證明：** 旨在支援無法使用 TPM 2.0 的現有主機硬體。 需要較少的設定步驟，並與一般伺服器硬體相容。 | 受防護主機的核准是根據擁有金鑰。 |

從 Windows Server 2019 開始，另一個名為「系統 **管理-信任證明」的** 模式已被取代。 此模式是以指定 Active Directory Domain Services (AD DS) 安全性群組中的受防護主機成員資格為基礎。 主機金鑰證明提供類似的主機識別，而且更容易設定。

## <a name="assurances-provided-by-the-host-guardian-service"></a>主機守護者服務提供的保證

HGS 與建立受防護的 VM 的方法搭配使用，協助提供以下保證。

| **VM 的保證類型**                         | **受防護的 VM 保證，來自金鑰保護服務以及受防護的 VM 建立方法** |
|----------------------------|--------------------------------------------------|
| **BitLocker 加密的磁碟 (作業系統磁碟和資料磁碟)**   | 受防護的 VM 會使用 BitLocker 保護其磁碟。 用來啟動 VM 和解密磁片所需的 BitLocker 金鑰，會受到受防護的 VM 虛擬 TPM 的保護，該虛擬 TPM 使用業界經過驗證的技術，例如安全測量的開機。 雖然受防護的 VM 僅會自動加密並保護作業系統磁碟，您也可以[加密資料磁碟機](/windows/security/information-protection/bitlocker/bitlocker-overview) (附加至受防護的 VM 的資料磁碟機)。 |
| **從「信任的」範本磁片/映射部署新的受防護 Vm** | 部署新的受防護的 VM 時，租用戶可指定他們所信任的範本磁碟。 受防護的範本磁碟在其內容被視為可信任時，會有以該時間點計算的簽章。 磁碟簽章接著會儲存在簽章目錄中，在建立受防護的 VM 時，租用戶可安全地提供給網狀架構。 在受防護的 VM 佈建期間，會再次計算磁碟的簽章，並與目錄中信任的簽章比較。 如果簽章相符，則會部署受防護的 VM。 如果簽章不相符，則會將受防護的範本磁碟視為不受信任，且部署會失敗。 |
| **受防護的 VM 建立後的密碼及其他機密資料保護** | 建立 Vm 時，必須確保 VM 密碼（例如受信任的磁片簽章、RDP 憑證和 VM 本機系統管理員帳戶的密碼）不會洩漏到網狀架構。 這些機密資料會儲存在稱為防護資料檔案 (PDK 檔案) 的加密檔案中，它受到租用戶金鑰保護，並且由租用戶上傳至網狀架構。 當受防護的 VM 建立後，租用戶選取要使用的防護資料，這些機密資料只會在受防護網狀架構中安全地提供給受信任的元件。 |
| **VM 可啟動位置的租用戶控制** | 防護資料也包含受防護網狀架構清單，特定受防護的 VM 可在其上執行。 這非常實用，例如，受防護的 VM 通常位於內部部署的私人雲端，但可能需要移轉至另一個 (公用或私人) 雲端以供災害復原用途使用。 目標雲端或網狀架構必須支援受防護的 VM，且受防護的 VM 必須允許網狀架構執行它。 |

## <a name="what-is-shielding-data-and-why-is-it-necessary"></a>什麼是防護資料，以及它為何是必要的？

防護資料檔案 (也稱為佈建資料檔案或 PDK 檔案) 是一種加密檔案，租用戶或 VM 擁有者會建立該檔案以保護重要的 VM 組態資訊，例如系統管理員密碼、RDP 及其他身分識別相關的憑證、網域加入認證等等。 建立受防護的 VM 時，網狀架構系統管理員會使用防護資料檔案，但無法檢視或使用檔案中包含的資訊。

其中，防護資料檔案會包含機密資料，例如：

- 系統管理員認證
- 回應檔案 (unattend.xml)
- 一種安全性原則，可判斷使用此防護資料建立的 Vm 是否設定為受防護或加密支援
    - 請記住，設定為受防護的 VM 會防止網狀架構系統管理員存取，而支援加密的 VM 則不會
- 保護與 VM 通訊之遠端桌面的 RDP 憑證
- 允許新的 VM 從中建立的磁碟區簽章目錄，其中包含受信任、已簽署的範本磁碟簽章清單
- 金鑰保護裝置 (或 KP)，定義受防護的 VM 被授權在哪些受防護網狀架構上執行

提供保證的防護資料檔案 (PDK 檔案)，讓 VM 能以租用戶想要的方式建立。 例如，當租用戶在防護資料檔案中放入回應檔案 (unattend.xml) 並傳遞給主機服務提供者時，主機服務提供者無法檢視或變更該回應檔案。 同樣地，主機服務提供者無法在建立受防護的 VM 時替換不同的 VHDX，因為防護資料檔案包含可從中建立受防護的 VM 的信任磁碟簽章。

下圖說明防護資料檔案和相關的組態項目。

![防護資料檔案](../media/Guarded-Fabric-Shielded-VM/shielded-vms-shielding-data-file.png)

## <a name="what-are-the-types-of-virtual-machines-that-a-guarded-fabric-can-run"></a>受防護網狀架構可執行的虛擬機器類型為何？

受防護網狀架構能夠以三種可能方式的其中之一執行 VM：

1. 一般的 VM 供應項目，不提供舊版本 Hyper-V 以外的保護
2. 支援加密的 VM，可由網狀架構系統管理員設定保護
3. 受防護的 VM，所有的保護均會開啟，並且無法由網狀架構系統管理員停用

支援加密的 VM 是專供在網狀架構系統管理員完全受信任時使用。  例如，企業可能會部署受防護網狀架構，以確保 VM 磁碟在靜止時會加密，以符合法規規定。 網狀架構系統管理員可以繼續使用便利的管理功能，例如 VM 主控台連線、PowerShell Direct，和其他日常的管理功能及疑難排解工具。

受防護的 VM 是專供在 VM 的資料和狀態必須受到的保護網狀架構中使用，避免網狀架構系統管理員以及可能在 Hyper-V 主機上執行之不受信任軟體的影響。 例如，受防護的 VM 將一律不允許 VM 主控台連線，而網狀架構系統管理員可在支援加密的 VM 上開啟或關閉這項保護。

下表摘要說明加密支援和受防護的 Vm 之間的差異。

| 功能        | 支援第 2 代加密     | 第 2 代防護         |
|----------|--------------------|----------------|
|安全開機        | 是，必要但可設定        | 是，必要且強制執行    |
|Vtpm               | 是，必要但可設定        | 是，必要且強制執行    |
|加密 VM 狀態和即時移轉流量 | 是，必要但可設定 |  是，必要且強制執行  |
|整合元件 | 可由網狀架構系統管理員設定      | 封鎖特定整合元件 (例如資料交換、PowerShell Direct) |
|虛擬機器連線 (主控台)、HID 裝置 (例如鍵盤、滑鼠) | 開啟，無法停用 | 從 Windows Server 1803 版開始的主機上啟用;在舊版主機上停用 |
|COM/序列通訊埠   | 支援                             | 停用 (無法啟用) |
|將偵錯工具 (附加至 VM 進程) <sup>1</sup>| 支援          | 停用 (無法啟用) |

<sup>1</sup> 將直接附加至進程（例如 WinDbg.exe）的傳統偵錯工具封鎖了受防護的 vm，因為 VM 的背景工作進程 ( # A1) 是受保護的進程 LIGHT (PPL) 。
替代的偵錯工具（例如 LiveKd.exe 所使用的技術）不會遭到封鎖。
與受防護的 Vm 不同的是，加密支援的 Vm 的背景工作進程不會以 PPL 的形式執行，因此 WinDbg.exe 之類的傳統偵錯工具會繼續正常運作。

受防護的 VM 和支援加密的 VM 皆會繼續支援一般的網狀架構管理功能，例如即時移轉、Hyper-V 複本、VM 檢查點等等。

## <a name="the-host-guardian-service-in-action-how-a-shielded-vm-is-powered-on"></a>作用中的主機守護者服務：如何開啟受防護的 VM

![防護資料檔案](../media/Guarded-Fabric-Shielded-VM/shielded-vms-how-a-shielded-vm-is-powered-on.png)

1. **VM01 已開啟。** 在受防護主機能夠開啟受防護的 VM 之前，它必須先明確證明其狀況良好。 若要證明其狀況良好，它必須向金鑰保護服務 (KPS) 提供健康情況的憑證。 健康情況的憑證是透過證明程序取得。

2. **主機要求證明。** 受防護主機會要求證明。 證明模式取決於「主機守護者服務」：

    - **TPM 信任的證明**： hyper-v 主機傳送的資訊包括：
      - TPM 識別資訊 (其簽署金鑰)
      - 最近開機順序期間所啟動程序的相關資訊 (TCG 記錄檔)
      - 已套用於主機上的程式碼完整性 (CI) 原則的相關資訊。

        主機啟動後便會發生證明，之後每隔 8 小時發生。 如果基於某些原因，主機在 VM 嘗試啟動時沒有證明憑證，這也會觸發證明。

    - **主機金鑰證明**： hyper-v 主機會傳送金鑰組的公開一半。 HGS 會驗證主機金鑰是否已註冊。

    - **系統管理信任證明**：Hyper-V 主機會傳送 Kerberos 票證，用來識別主機所在的安全性群組。 HGS 會驗證主機所屬的安全性群組是由受信任的 HGS 系統管理員在先前所設定。

3. **證明成功 (或失敗)。** 證明模式會決定成功證明主機狀況良好所需的檢查。 使用 TPM 信任證明時，會驗證主機的 TPM 身分識別、開機測量和程式碼完整性原則。 使用主機金鑰證明，只會驗證主機金鑰的註冊。

4. **證明憑證傳送給主機。** 假設證明成功，就會將健康情況憑證傳送至主機，而主機會被視為「受防護」 (有權執行受防護的 Vm) 。 主機會使用健康情況憑證來授權金鑰保護服務以安全地發行和受防護的 VM 搭配使用的金鑰

5. **主機要求 VM 金鑰。** 受防護主機沒有開啟受防護的 VM (在此案例中為 VM01) 所需的金鑰。 若要取得必要金鑰，受防護主機必須向 KPS 提供下列項目：

   - 目前的健康情況憑證
   - 加密的機密資料 (金鑰保護裝置或 KP)，其中包含開啟 VM01 所需的金鑰。 機密資料是使用只有 KPS 知道的其他金鑰來加密。

6. **金鑰發行。** KPS 會檢查健康情況憑證以判斷其有效性。 憑證必須尚未過期，且 KPS 必須信任發出憑證的證明服務。

7. **金鑰傳回至主機。** 如果健康情況憑證有效，KPS 會嘗試解密機密資料，並安全地傳回開啟 VM 所需的金鑰。 請注意，金鑰會加密為受防護主機的 VBS。

8. **主機開啟 VM01。**

## <a name="guarded-fabric-and-shielded-vm-glossary"></a>受防護網狀架構與受防護的 VM 詞彙

| 詞彙              | 定義           |
|----------|------------|
| 主機守護者服務 (HGS) | 安裝於裸機伺服器安全叢集上的 Windows Server 角色，可測量 Hyper-V 主機的健康情況，並在開啟或即時移轉受防護的 VM 時對狀況良好的 Hyper-V 主機發行金鑰。 這兩項功能是受防護的 VM 解決方案的基礎，並分別稱為 **證明服務** 和 **金鑰保護服務**。 |
| 受防護主機 | 可執行受防護的 VM 的 Hyper-V 主機。 主機在被 HGS 證明服務視為狀況良好時，才會被視為 _受保護_ 。 受防護的 VM 無法在尚未證明或證明失敗的 Hyper-V 主機上開啟或即時移轉至該主機。 |
| 受防護網狀架構    | 這是一個集合詞彙，用於描述 Hyper-V 主機的網狀架構，以及它們可管理和執行受防護的 VM 主機守護者服務。 |
| 受防護的虛擬機器 (VM) | 僅能在受防護主機上執行的虛擬機器，並且可防範惡意網狀架構系統管理員及主機惡意程式碼檢查、竄改及竊盜。 |
| 網狀架構系統管理員 | 可管理虛擬機器的公用或私人雲端系統管理員。 在受防護網狀架構內容中，網狀架構系統管理員不具有受防護的 VM，或是決定受防護的 VM 可在哪些主機上執行之原則的存取權限。 |
| HGS 系統管理員 | 公用或私人雲端中受信任的系統管理員，有權管理受防護主機 (即為可執行受防護的 VM 的主機) 的原則和密碼編譯內容。|
| 佈建資料檔案或防護資料檔案 (PDK 檔案) | 租用戶或使用者建立的加密檔案，用來保存重要的 VM 組態資訊，並保護該資訊防止其他人存取。 例如，防護資料檔案可以包含 VM 建立時指派給本機 Administrator 帳戶的密碼。 |
| 虛擬化安全性 (VBS) | 以 Hyper-v 為基礎的處理和儲存環境，受系統管理員保護。 「虛擬安全模式」提供系統儲存作業系統金鑰的能力，該金鑰不會對作業系統管理員顯示。|
| 虛擬 TPM | 信賴平台模組 (TPM) 的虛擬化版本。 從 Windows Server 2016 中的 Hyper-v 開始，您可以提供虛擬 TPM 2.0 裝置，讓虛擬機器可以加密，就像實體 TPM 允許加密實體電腦一樣。|

## <a name="additional-references"></a>其他參考資料

- [受防護網狀架構與受防護的 VM](guarded-fabric-and-shielded-vms-top-node.md)
- Blog： [Datacenter 和私用雲端安全性的 blog](/archive/blogs/datacentersecurity/)
- 影片： [受防護虛擬機器的簡介](https://channel9.msdn.com/Shows/Mechanics/Introduction-to-Shielded-Virtual-Machines-in-Windows-Server-2016)
- 影片： [利用 Windows Server 2016 Hyper-v 深入探索受防護的 vm](https://channel9.msdn.com/events/Ignite/2016/BRK3124)
